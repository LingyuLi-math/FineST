<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FineST in NPC Visium data &mdash; FineST 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="_static/nbsphinx-code-cells.css" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Release History" href="release.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            FineST
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Main</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="release.html">Release History</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">FineST in NPC Visium data</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Main-steps">Main steps</a></li>
<li class="toctree-l2"><a class="reference internal" href="#1.-Load-Spatial-and-Image-data">1. Load Spatial and Image data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#2-Train-and-Test-model">2 Train and Test model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#3.-Inference,-Imputation-and-Evaluation-on-within-spot">3. Inference, Imputation and Evaluation on within spot</a></li>
<li class="toctree-l2"><a class="reference internal" href="#4.-Inference-model-for-%22within-spot%22-and-%22between-spot%22">4. Inference model for “within spot” and “between spot”</a></li>
<li class="toctree-l2"><a class="reference internal" href="#5.-Imputation-using-measured-spot-expressiom">5. Imputation using measured spot expressiom</a></li>
<li class="toctree-l2"><a class="reference internal" href="#6.-Save-all-subspot-imupted-data">6. Save all subspot imupted data</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">FineST</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">FineST in NPC Visium data</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/BRCA_Train2.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="FineST-in-NPC-Visium-data">
<h1>FineST in NPC Visium data<a class="headerlink" href="#FineST-in-NPC-Visium-data" title="Permalink to this heading"></a></h1>
<section id="Main-steps">
<h2>Main steps<a class="headerlink" href="#Main-steps" title="Permalink to this heading"></a></h2>
<ul class="simple">
<li><p>Step1: Prepare the paired image and expression</p></li>
<li><p>Step2: Train and test the model within spot</p></li>
<li><p>Step3: infer gene expression of between spot</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">tifffile</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.optim</span> <span class="k">as</span> <span class="nn">optim</span>
<span class="kn">from</span> <span class="nn">torch.</span> <span class="n">utils</span><span class="o">.</span><span class="n">data</span> <span class="kn">import</span> <span class="nn">DataLoader</span><span class="o">,</span> <span class="nn">Dataset</span><span class="o">,</span> <span class="nn">TensorDataset</span>
<span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="kn">import</span> <span class="n">csr_matrix</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">scanpy</span> <span class="k">as</span> <span class="nn">sc</span>
<span class="kn">import</span> <span class="nn">anndata</span>

<span class="kn">import</span> <span class="nn">FineST</span> <span class="k">as</span> <span class="nn">fst</span>
<span class="kn">from</span> <span class="nn">FineST.datasets</span> <span class="kn">import</span> <span class="n">dataset</span>
<span class="kn">from</span> <span class="nn">FineST.utils</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">FineST.loadData</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">FineST.model</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">FineST.train</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">FineST.inference</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">FineST.evaluation</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">FineST.imputation</span> <span class="kn">import</span> <span class="o">*</span>

<span class="nb">print</span><span class="p">(</span><span class="n">h5py</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;FineST version: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="k">fst</span>.__version__)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
3.10.0
1.7.1
FineST version: 0.0.1
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/mnt/lingyu/nfs_share2/Python/&#39;</span>
<span class="n">setup_seed</span><span class="p">(</span><span class="mi">666</span><span class="p">)</span>

<span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
    <span class="n">dev</span> <span class="o">=</span> <span class="s2">&quot;cuda:0&quot;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">dev</span> <span class="o">=</span> <span class="s2">&quot;cpu&quot;</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">matplotlib.colors</span> <span class="k">as</span> <span class="nn">clr</span>
<span class="n">cnt_color</span> <span class="o">=</span> <span class="n">clr</span><span class="o">.</span><span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s1">&#39;magma&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;#000003&quot;</span><span class="p">,</span>  <span class="s2">&quot;#3b0f6f&quot;</span><span class="p">,</span>  <span class="s2">&quot;#8c2980&quot;</span><span class="p">,</span>   <span class="s2">&quot;#f66e5b&quot;</span><span class="p">,</span> <span class="s2">&quot;#fd9f6c&quot;</span><span class="p">,</span> <span class="s2">&quot;#fbfcbf&quot;</span><span class="p">],</span> <span class="n">N</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">##############################################################</span>
<span class="c1"># make logging and save model</span>
<span class="c1">##############################################################</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

<span class="n">model_folder</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;FineST/FineST/Finetune/&#39;</span>
<span class="n">dir_name</span> <span class="o">=</span> <span class="n">model_folder</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">%H%M%S</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dir_name</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dir_name</span><span class="p">)</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">setup_logger</span><span class="p">(</span><span class="n">dir_name</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">dir_name</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
/mnt/lingyu/nfs_share2/Python/FineST/FineST/Finetune/20241006221845787989
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">##############################################################</span>
<span class="c1"># load parameter settings</span>
<span class="c1">##############################################################</span>

<span class="kn">import</span> <span class="nn">json</span>
<span class="n">parameter_file_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;FineST/FineST/Parameter/parameters_NPC_P10125.json&#39;</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">parameter_file_path</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>

<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Load parameters:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
[2024-10-06 22:18:45] INFO - Load parameters:
{
  &#34;n_encoder_hidden_matrix&#34;: 256,
  &#34;n_encoder_hidden_image&#34;: 128,
  &#34;n_encoder_latent&#34;: 128,
  &#34;n_projection_hidden&#34;: 256,
  &#34;n_projection_output&#34;: 128,
  &#34;batch_size&#34;: 200,
  &#34;batch_size_pair&#34;: 64,
  &#34;n_encoder_layers&#34;: 2,
  &#34;dropout_rate&#34;: 0,
  &#34;training_epoch&#34;: 50,
  &#34;inital_learning_rate&#34;: 0.1,
  &#34;k_nearest_positives&#34;: 0,
  &#34;temperature&#34;: 0.03
}
</pre></div></div>
</div>
</section>
<section id="1.-Load-Spatial-and-Image-data">
<h2>1. Load Spatial and Image data<a class="headerlink" href="#1.-Load-Spatial-and-Image-data" title="Permalink to this heading"></a></h2>
<p>1.1 Load spatial data</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">NPC</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
AnnData object with n_obs × n_vars = 1331 × 36601
    obs: &#39;in_tissue&#39;, &#39;array_row&#39;, &#39;array_col&#39;
    var: &#39;gene_ids&#39;, &#39;feature_types&#39;, &#39;genome&#39;
    uns: &#39;spatial&#39;
    obsm: &#39;spatial&#39;
</pre></div></div>
</div>
<p>1.2 Selected LR genes</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">load_lr_genes</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;FineST/FineST/Dataset/LRgene/LRgene_CellChatDB_baseline.csv&#39;</span><span class="p">)</span>
    <span class="n">LRgene</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">LRgene</span><span class="p">[</span><span class="s1">&#39;LR gene&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">adata_LR</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">gene_list</span><span class="p">):</span>
    <span class="n">adata_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obs_names</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="p">)</span>
    <span class="n">available_genes</span> <span class="o">=</span> <span class="p">[</span><span class="n">gene</span> <span class="k">for</span> <span class="n">gene</span> <span class="ow">in</span> <span class="n">gene_list</span> <span class="k">if</span> <span class="n">gene</span> <span class="ow">in</span> <span class="n">adata_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">adataLR_matrix</span> <span class="o">=</span> <span class="n">adata_matrix</span><span class="p">[</span><span class="n">available_genes</span><span class="p">]</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">_n_vars</span> <span class="o">=</span> <span class="n">adataLR_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">adataLR_matrix</span><span class="o">.</span><span class="n">values</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">available_genes</span><span class="p">]</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">var_names</span> <span class="o">=</span> <span class="n">adataLR_matrix</span><span class="o">.</span><span class="n">columns</span>
    <span class="k">return</span> <span class="n">adata</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Load LR 963 genes and extract their gene expression</span>
<span class="n">adata</span> <span class="o">=</span> <span class="n">adata_LR</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">load_lr_genes</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
<span class="n">adata</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
AnnData object with n_obs × n_vars = 1331 × 911
    obs: &#39;in_tissue&#39;, &#39;array_row&#39;, &#39;array_col&#39;
    var: &#39;gene_ids&#39;, &#39;feature_types&#39;, &#39;genome&#39;
    uns: &#39;spatial&#39;
    obsm: &#39;spatial&#39;
</pre></div></div>
</div>
<p>1.3 Data preprocess</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">adata_preprocess</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">min_cells</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">target_sum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_top_genes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">var_names_make_unique</span><span class="p">()</span>

    <span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;mt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;MT-&quot;</span><span class="p">)</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">calculate_qc_metrics</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">qc_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mt&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">filter_genes</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">min_cells</span><span class="o">=</span><span class="n">min_cells</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">n_top_genes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">normalize_total</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">target_sum</span><span class="o">=</span><span class="n">target_sum</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">normalize_total</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>

    <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">n_top_genes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">highly_variable_genes</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">flavor</span><span class="o">=</span><span class="s2">&quot;seurat&quot;</span><span class="p">,</span> <span class="n">n_top_genes</span><span class="o">=</span><span class="n">n_top_genes</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">adata</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata</span> <span class="o">=</span> <span class="n">adata_preprocess</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
AnnData object with n_obs × n_vars = 1331 × 596
    obs: &#39;in_tissue&#39;, &#39;array_row&#39;, &#39;array_col&#39;, &#39;n_genes_by_counts&#39;, &#39;log1p_n_genes_by_counts&#39;, &#39;total_counts&#39;, &#39;log1p_total_counts&#39;, &#39;pct_counts_in_top_50_genes&#39;, &#39;pct_counts_in_top_100_genes&#39;, &#39;pct_counts_in_top_200_genes&#39;, &#39;pct_counts_in_top_500_genes&#39;, &#39;total_counts_mt&#39;, &#39;log1p_total_counts_mt&#39;, &#39;pct_counts_mt&#39;
    var: &#39;gene_ids&#39;, &#39;feature_types&#39;, &#39;genome&#39;, &#39;mt&#39;, &#39;n_cells_by_counts&#39;, &#39;mean_counts&#39;, &#39;log1p_mean_counts&#39;, &#39;pct_dropout_by_counts&#39;, &#39;total_counts&#39;, &#39;log1p_total_counts&#39;, &#39;n_cells&#39;
    uns: &#39;spatial&#39;, &#39;log1p&#39;
    obsm: &#39;spatial&#39;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gene_hv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;gene_hv length:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">gene_hv</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
gene_hv length: 596
</pre></div></div>
</div>
<p>1.4 Reload adata with selected gene</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Access the matrix and convert it to a dense matrix</span>
<span class="n">matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>
<span class="n">matrix</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">gene_hv</span>
<span class="n">spotID</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;in_tissue&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">matrix</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">spotID</span><span class="p">)</span>
<span class="n">matrix</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">matrix</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(1331, 596)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>TGFB1</th>
      <th>TGFBR1</th>
      <th>TGFBR2</th>
      <th>TGFB2</th>
      <th>TGFB3</th>
      <th>ACVR1B</th>
      <th>ACVR1C</th>
      <th>ACVR1</th>
      <th>BMP2</th>
      <th>BMPR1A</th>
      <th>...</th>
      <th>KDR</th>
      <th>TREM2</th>
      <th>SEMA6A</th>
      <th>SEMA6B</th>
      <th>SEMA7A</th>
      <th>PLXNC1</th>
      <th>SIGLEC1</th>
      <th>THY1</th>
      <th>VCAM1</th>
      <th>VSIR</th>
    </tr>
    <tr>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>AAACAATCTACTAGCA-1</th>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.00000</td>
      <td>0.0</td>
      <td>0.784856</td>
      <td>0.784856</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.0000</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.784856</td>
      <td>0.000000</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>AAACGAAGAACATACC-1</th>
      <td>1.538792</td>
      <td>0.000000</td>
      <td>0.00000</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.0</td>
      <td>0.797351</td>
      <td>0.000000</td>
      <td>0.0000</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.797351</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.797351</td>
      <td>0.000000</td>
      <td>1.235270</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>AAAGGGATGTAGCAAG-1</th>
      <td>0.000000</td>
      <td>0.481666</td>
      <td>0.00000</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.481666</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.0000</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.481666</td>
      <td>1.409484</td>
      <td>0.481666</td>
    </tr>
    <tr>
      <th>AAAGTCACTGATGTAA-1</th>
      <td>0.000000</td>
      <td>0.633767</td>
      <td>0.00000</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>1.018628</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.0000</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.633767</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.633767</td>
      <td>0.000000</td>
      <td>1.512659</td>
      <td>0.633767</td>
    </tr>
    <tr>
      <th>AAAGTGTGATTTATCT-1</th>
      <td>0.501523</td>
      <td>0.000000</td>
      <td>1.08306</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.0000</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.501523</td>
      <td>0.833982</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>TTGTGGCCCTGACAGT-1</th>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.00000</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.0</td>
      <td>0.888100</td>
      <td>0.000000</td>
      <td>0.8881</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.0</td>
      <td>0.888100</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.888100</td>
      <td>0.888100</td>
    </tr>
    <tr>
      <th>TTGTGTTTCCCGAAAG-1</th>
      <td>0.890100</td>
      <td>0.000000</td>
      <td>0.00000</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.0000</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.0</td>
      <td>0.540979</td>
      <td>0.540979</td>
      <td>0.000000</td>
      <td>0.540979</td>
      <td>0.540979</td>
      <td>0.890100</td>
    </tr>
    <tr>
      <th>TTGTTAGCAAATTCGA-1</th>
      <td>0.457721</td>
      <td>0.457721</td>
      <td>0.00000</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.457721</td>
      <td>0.0</td>
      <td>0.457721</td>
      <td>0.457721</td>
      <td>0.0000</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.457721</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>1.500249</td>
      <td>0.457721</td>
    </tr>
    <tr>
      <th>TTGTTCAGTGTGCTAC-1</th>
      <td>1.879867</td>
      <td>0.000000</td>
      <td>0.00000</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.0000</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>2.493640</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>TTGTTTGTGTAAATTC-1</th>
      <td>0.888100</td>
      <td>0.000000</td>
      <td>0.00000</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.888100</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.0000</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.888100</td>
      <td>1.350931</td>
    </tr>
  </tbody>
</table>
<p>1331 rows × 596 columns</p>
</div></div>
</div>
<p>1.5 Order by image file name</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="n">file_paths</span><span class="p">,</span> <span class="n">data_name</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">file_paths</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">file_paths</span><span class="p">:</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">file_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data_name</span> <span class="o">==</span> <span class="s2">&quot;BRCA&quot;</span><span class="p">:</span>
            <span class="n">part_3</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">part_4</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">data_name</span> <span class="o">==</span> <span class="s2">&quot;NPC&quot;</span><span class="p">:</span>
            <span class="n">part_3</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">part_4</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid data_name. Please use &#39;NPC&#39; or &#39;BRCA&#39;&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">part_3</span><span class="p">,</span> <span class="n">part_4</span><span class="p">])</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pixel_y&#39;</span><span class="p">,</span> <span class="s1">&#39;pixel_x&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;pixel_x&#39;</span><span class="p">,</span> <span class="s1">&#39;pixel_y&#39;</span><span class="p">]]</span>

<span class="k">def</span> <span class="nf">merge_dfs</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
    <span class="n">merged_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pixel_x&#39;</span><span class="p">,</span> <span class="s1">&#39;pixel_y&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">cols</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;pixel_x&#39;</span><span class="p">)</span>
    <span class="n">cols</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;pixel_y&#39;</span><span class="p">)</span>
    <span class="n">merged_df</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[</span><span class="n">cols</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;pixel_x&#39;</span><span class="p">,</span> <span class="s1">&#39;pixel_y&#39;</span><span class="p">]]</span>
    <span class="n">col_x</span> <span class="o">=</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">col_y</span> <span class="o">=</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">col_x</span><span class="p">:</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">col_y</span><span class="p">:</span> <span class="s1">&#39;y&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Load image embedding from HIPT</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;NPC/Data/stdata/ZhuoLiang/LLYtest/AH_Patient1_pth_64_16/&#39;</span><span class="p">)</span>
<span class="n">file_paths</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;NPC/Data/stdata/ZhuoLiang/LLYtest/AH_Patient1_pth_64_16/&#39;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Image embedding file:&quot;</span><span class="p">,</span> <span class="n">file_paths</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">get_data</span><span class="p">(</span><span class="n">file_paths</span><span class="p">,</span> <span class="n">data_name</span><span class="o">=</span><span class="s2">&quot;NPC&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Image embedding file: [&#39;AH_Patient1_10014_10023.pth&#39;, &#39;AH_Patient1_10015_9649.pth&#39;, &#39;AH_Patient1_10016_9276.pth&#39;]
(1331, 2)
   pixel_x  pixel_y
0    10023    10014
1     9649    10015
2     9276    10016
3     7783    10020
4     7410    10021
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## position</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;FineST/FineST/Dataset/NPC/patient1/&#39;</span><span class="p">)</span>
<span class="n">position</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;tissue_positions_list.csv&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">position</span> <span class="o">=</span> <span class="n">position</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">position</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]:</span> <span class="s1">&#39;pixel_x&#39;</span><span class="p">,</span> <span class="n">position</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span> <span class="s1">&#39;pixel_y&#39;</span><span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>

<span class="c1">## merge position</span>
<span class="n">position_image</span> <span class="o">=</span> <span class="n">merge_dfs</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span>
<span class="n">spotID_order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">position_image</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">position_image</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(4992, 6)
                    0  1  2  3  pixel_x  pixel_y
0  ACGCCTGACACGCGCT-1  0  0  0     1416     1884
1  TACCGATCCAACACTT-1  0  1  1     1603     1991
2  ATTAAAGCGGACGAGC-1  0  0  2     1417     2098
3  GATAAGGGACGATTAG-1  0  1  3     1604     2205
4  GTGCAAATCACCAATA-1  0  0  4     1417     2313
                    0  1   x   y  pixel_x  pixel_y
0  GTCGTTATTCGCTTAT-1  1  46  76    10023    10014
1  ACAAGGGCAGGCTCTG-1  1  44  76     9649    10015
2  TGCGTTTGTTGACACT-1  1  42  76     9276    10016
3  TTGAATATGGACTTTC-1  1  34  76     7783    10020
4  CCGGGCGGTCTCGTCA-1  1  32  76     7410    10021
</pre></div></div>
</div>
<p>1.6 Order matrix low, spatial corr by image file name</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sort_matrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">position_image</span><span class="p">):</span>
    <span class="n">position_image_first_col</span> <span class="o">=</span> <span class="n">position_image</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">matrix</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">matrix</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">position_image_first_col</span><span class="p">})</span>
    <span class="n">sorted_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">position_image</span><span class="p">[[</span><span class="n">position_image_first_col</span><span class="p">]],</span> <span class="n">matrix</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">position_image_first_col</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
    <span class="n">matrix_order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sorted_matrix</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">position_image_first_col</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">matrix_order</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">matrix_order</span> <span class="o">=</span> <span class="n">sort_matrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">position_image</span><span class="p">)</span>
<span class="n">matrix_order_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">matrix_order</span><span class="p">)</span>
<span class="n">matrix_order_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">spotID_order</span>
<span class="n">matrix_order_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">gene_hv</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## save gene expression mateix</span>
<span class="c1"># np.save(str(path)+&#39;FineST/FineST/Dataset/NPC/ContrastP1geneLR/harmony_matrix.npy&#39;, matrix_order_df.T)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">update_adata</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">matrix_order</span><span class="p">,</span> <span class="n">position_image</span><span class="p">):</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">csr_matrix</span><span class="p">(</span><span class="n">matrix_order</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;spatial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">position_image</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s1">&#39;pixel_y&#39;</span><span class="p">,</span> <span class="s1">&#39;pixel_x&#39;</span><span class="p">]])</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;array_row&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">position_image</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;y&#39;</span><span class="p">])</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;array_col&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">position_image</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;x&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">adata</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata</span> <span class="o">=</span> <span class="n">update_adata</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">matrix_order</span><span class="p">,</span> <span class="n">position_image</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
AnnData object with n_obs × n_vars = 1331 × 596
    obs: &#39;in_tissue&#39;, &#39;array_row&#39;, &#39;array_col&#39;, &#39;n_genes_by_counts&#39;, &#39;log1p_n_genes_by_counts&#39;, &#39;total_counts&#39;, &#39;log1p_total_counts&#39;, &#39;pct_counts_in_top_50_genes&#39;, &#39;pct_counts_in_top_100_genes&#39;, &#39;pct_counts_in_top_200_genes&#39;, &#39;pct_counts_in_top_500_genes&#39;, &#39;total_counts_mt&#39;, &#39;log1p_total_counts_mt&#39;, &#39;pct_counts_mt&#39;
    var: &#39;gene_ids&#39;, &#39;feature_types&#39;, &#39;genome&#39;, &#39;mt&#39;, &#39;n_cells_by_counts&#39;, &#39;mean_counts&#39;, &#39;log1p_mean_counts&#39;, &#39;pct_dropout_by_counts&#39;, &#39;total_counts&#39;, &#39;log1p_total_counts&#39;, &#39;n_cells&#39;
    uns: &#39;spatial&#39;, &#39;log1p&#39;
    obsm: &#39;spatial&#39;
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## save the original adata</span>
<span class="c1"># patientxy = &#39;patient1&#39;</span>
<span class="c1"># adata.write_h5ad(str(path)+&#39;FineST/FineST/Dataset/ImputData/&#39;+str(patientxy)+&#39;/&#39;+str(patientxy)+&#39;_adata_orignal.h5ad&#39;)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">########################################</span>
<span class="c1"># save image position: only run once</span>
<span class="c1">########################################</span>
<span class="n">position_order</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s2">&quot;pixel_y&quot;</span><span class="p">:</span> <span class="n">position_image</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;pixel_y&#39;</span><span class="p">],</span>
    <span class="s2">&quot;pixel_x&quot;</span><span class="p">:</span> <span class="n">position_image</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;pixel_x&#39;</span><span class="p">],</span>
    <span class="s2">&quot;array_row&quot;</span><span class="p">:</span> <span class="n">position_image</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;y&#39;</span><span class="p">],</span>
    <span class="s2">&quot;array_col&quot;</span><span class="p">:</span> <span class="n">position_image</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;x&#39;</span><span class="p">]</span>
<span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="n">position_order</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
      pixel_y  pixel_x  array_row  array_col
0       10014    10023         76         46
1       10015     9649         76         44
2       10016     9276         76         42
3       10020     7783         76         34
4       10021     7410         76         32
...       ...      ...        ...        ...
1326     9922     4237         75         15
1327     9923     3490         75         11
1328     9924     3117         75          9
1329     9925     2743         75          7
1330     9927     1997         75          3

[1331 rows x 4 columns]
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## save the position data</span>
<span class="c1"># position_order.to_csv(str(path)+&#39;FineST/FineST/Dataset/NPC/ContrastP1geneLR/position_order.csv&#39;, index=False, header=False)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gene_selet</span> <span class="o">=</span> <span class="s1">&#39;CD70&#39;</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="n">spatial_loc</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;spatial&#39;</span><span class="p">]</span>
<span class="n">scatter_plot</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;spatial&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span><span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;spatial&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">],</span>
                           <span class="n">c</span><span class="o">=</span><span class="n">matrix_order_df</span><span class="p">[</span><span class="n">gene_selet</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cnt_color</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">gene_selet</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; Expression&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scatter_plot</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_dpi</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/BRCA_Train2_31_0.png" src="_images/BRCA_Train2_31_0.png" />
</div>
</div>
</section>
<section id="2-Train-and-Test-model">
<h2>2 Train and Test model<a class="headerlink" href="#2-Train-and-Test-model" title="Permalink to this heading"></a></h2>
<p>2.1 Data loader and splitting</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">build_loaders</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">image_embed_path</span><span class="p">):</span>

    <span class="n">setup_seed</span><span class="p">(</span><span class="mi">666</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;***** Building loaders *****&quot;</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">glob</span>
    <span class="n">image_paths</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">image_embed_path</span><span class="p">))</span>
    <span class="n">image_paths</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

    <span class="n">dataset</span> <span class="o">=</span> <span class="n">DatasetCreat</span><span class="p">(</span>
        <span class="n">image_paths</span><span class="o">=</span><span class="n">image_paths</span><span class="p">,</span>
        <span class="n">spatial_pos_path</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;FineST/FineST/Dataset/NPC/ContrastP1geneLR/position_order.csv&#39;</span><span class="p">,</span>
        <span class="n">reduced_mtx_path</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;FineST/FineST/Dataset/NPC/ContrastP1geneLR/harmony_matrix.npy&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">train_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.8</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">))</span>
    <span class="n">test_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="o">-</span> <span class="n">train_size</span>
    <span class="c1"># train_dataset, test_dataset = torch.utils.data.random_split(dataset, [train_size, test_size], generator=torch.Generator().manual_seed(42))</span>
    <span class="n">train_dataset</span><span class="p">,</span> <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">random_split</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="p">[</span><span class="n">train_size</span><span class="p">,</span> <span class="n">test_size</span><span class="p">])</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;train/test split completed&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">))</span>

    <span class="c1">## Set up distributed sampler</span>
    <span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop_last</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">test_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop_last</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;***** Finished building loaders *****&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">test_loader</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">image_embed_path_NPC</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;NPC/Data/stdata/ZhuoLiang/LLYtest/AH_Patient1_pth_64_16/*.pth&#39;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">image_embed_path_NPC</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
/mnt/lingyu/nfs_share2/Python/NPC/Data/stdata/ZhuoLiang/LLYtest/AH_Patient1_pth_64_16/*.pth
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## split training data and test data</span>
<span class="n">train_loader</span><span class="p">,</span> <span class="n">test_loader</span> <span class="o">=</span> <span class="n">build_loaders</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">],</span> <span class="n">image_embed_path</span><span class="o">=</span><span class="n">image_embed_path_NPC</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
***** Building loaders *****
Finished loading all files
train/test split completed
1064 267
***** Finished building loaders *****
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">build_loaders_inference</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">image_embed_path</span><span class="p">):</span>

    <span class="n">setup_seed</span><span class="p">(</span><span class="mi">666</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;***** Building loaders_inference *****&quot;</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">glob</span>
    <span class="n">image_paths</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">image_embed_path</span><span class="p">))</span>
    <span class="n">image_paths</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

    <span class="n">dataset</span> <span class="o">=</span> <span class="n">DatasetCreat</span><span class="p">(</span>
        <span class="n">image_paths</span><span class="o">=</span><span class="n">image_paths</span><span class="p">,</span>
        <span class="n">spatial_pos_path</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;FineST/FineST/Dataset/NPC/ContrastP1geneLR/position_order.csv&#39;</span><span class="p">,</span>
        <span class="n">reduced_mtx_path</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;FineST/FineST/Dataset/NPC/ContrastP1geneLR/harmony_matrix.npy&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">all_dataset</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;***** Finished building loaders_inference *****&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">all_dataset</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_dataset</span> <span class="o">=</span> <span class="n">build_loaders_inference</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">image_embed_path</span><span class="o">=</span><span class="n">image_embed_path_NPC</span><span class="p">)</span>
<span class="n">input_spot_all</span><span class="p">,</span> <span class="n">input_image_all</span><span class="p">,</span> <span class="n">input_coord_all</span><span class="p">,</span> <span class="n">input_row_all</span><span class="p">,</span> <span class="n">input_col_all</span> <span class="o">=</span> <span class="n">extract_test_data</span><span class="p">(</span><span class="n">all_dataset</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;input_spot_all:&quot;</span><span class="p">,</span> <span class="n">input_spot_all</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;input_image_all:&quot;</span><span class="p">,</span> <span class="n">input_image_all</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="c1"># print(input_image_all)</span>
<span class="c1"># print(input_spot_all)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
***** Building loaders_inference *****
Finished loading all files
***** Finished building loaders_inference *****
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:02&lt;00:00,  2.83s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
***** batch_size=adata.shape[0] 不影响 *****
torch.Size([1331, 596])
torch.Size([1331, 16, 384])
1
1
1
***** *****
Finished extractting test data
input_spot_all: torch.Size([1331, 596])
input_image_all: torch.Size([1331, 16, 384])
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">input_spot_test</span><span class="p">,</span> <span class="n">input_image_test</span><span class="p">,</span> <span class="n">input_coord_test</span><span class="p">,</span> <span class="n">input_row_test</span><span class="p">,</span> <span class="n">input_col_test</span> <span class="o">=</span> <span class="n">extract_test_data</span><span class="p">(</span><span class="n">test_loader</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;input_spot_test:&quot;</span><span class="p">,</span> <span class="n">input_spot_test</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;input_image_test:&quot;</span><span class="p">,</span> <span class="n">input_image_test</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="c1"># print(input_image_test)</span>
<span class="c1"># print(input_spot_test)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 46.50it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
***** batch_size=adata.shape[0] 不影响 *****
torch.Size([200, 596])
torch.Size([200, 16, 384])
1
1
1
***** *****
Finished extractting test data
input_spot_test: torch.Size([200, 596])
input_image_test: torch.Size([200, 16, 384])
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<p>2.2 Train and test model on within spot</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### load parameter settings</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">parameter_file_path</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>

<span class="c1">## add params</span>
<span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_input_matrix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gene_hv</span><span class="p">)</span>
<span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_input_image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">384</span>

<span class="c1">## init the model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">CellContrastModel</span><span class="p">(</span><span class="n">n_input_matrix</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_input_matrix&#39;</span><span class="p">],</span>
                          <span class="n">n_input_image</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_input_image&#39;</span><span class="p">],</span>
                          <span class="n">n_encoder_hidden_matrix</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;n_encoder_hidden_matrix&quot;</span><span class="p">],</span>
                          <span class="n">n_encoder_hidden_image</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;n_encoder_hidden_image&quot;</span><span class="p">],</span>
                          <span class="n">n_encoder_latent</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;n_encoder_latent&quot;</span><span class="p">],</span>
                          <span class="n">n_projection_hidden</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;n_projection_hidden&quot;</span><span class="p">],</span>
                          <span class="n">n_projection_output</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;n_projection_output&quot;</span><span class="p">],</span>
                          <span class="n">n_encoder_layers</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;n_encoder_layers&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">l</span> <span class="o">=</span> <span class="n">ContrastiveLoss</span><span class="p">(</span><span class="n">temperature</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">])</span>
<span class="c1"># print(model)</span>

<span class="c1">## Set optimizer</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;inital_learning_rate&#39;</span><span class="p">],</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">5e-4</span><span class="p">)</span>

<span class="c1">## Load the data</span>
<span class="n">train_loader</span><span class="p">,</span> <span class="n">test_loader</span> <span class="o">=</span> <span class="n">build_loaders</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">],</span> <span class="n">image_embed_path</span><span class="o">=</span><span class="n">image_embed_path_NPC</span><span class="p">)</span>


<span class="c1"># Train the model for a fixed number of epoch</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Begin Training ...&#39;</span><span class="p">)</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">best_loss</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
<span class="n">best_epoch</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;training_epoch&#39;</span><span class="p">]):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;epoch [</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">epoch</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Epoch: </span><span class="si">{</span><span class="n">epoch</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1">######################################################################################</span>
    <span class="c1"># Train the model</span>
    <span class="c1">######################################################################################</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
    <span class="n">train_loss</span> <span class="o">=</span> <span class="n">train_model</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>    <span class="c1"># LOSS</span>

    <span class="c1">######################################################################################</span>
    <span class="c1"># Evaluate the model</span>
    <span class="c1">######################################################################################</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">test_loss</span> <span class="o">=</span> <span class="n">test_model</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">best_loss</span> <span class="o">&gt;</span> <span class="n">test_loss</span><span class="p">:</span>
        <span class="n">best_loss</span> <span class="o">=</span> <span class="n">test_loss</span>
        <span class="n">best_epoch</span> <span class="o">=</span> <span class="n">epoch</span>

        <span class="n">save_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dir_name</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">train_loss</span><span class="p">)</span>
        <span class="c1"># torch.save(model.state_dict(), &quot;STFinetune/best.pt&quot;)    # BLEEP</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saved Best epoch &amp; Best Model! Loss: [</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">best_epoch</span><span class="p">,</span> <span class="n">best_loss</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saved Best epoch &amp; Best Model! Loss: [</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">best_epoch</span><span class="p">,</span> <span class="n">best_loss</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done!, final loss: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">best_loss</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Best epoch: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">best_epoch</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- </span><span class="si">%s</span><span class="s2"> seconds ---&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>

<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Done!, Best epoch &amp; Best Model! Loss: [</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">best_epoch</span><span class="p">,</span> <span class="n">best_loss</span><span class="p">))</span>

<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Finished Training&#39;</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
***** Building loaders *****
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
[2024-10-05 23:55:22] INFO - Begin Training ...
[2024-10-05 23:55:22] INFO - epoch [1/0]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Finished loading all files
train/test split completed
1064 267
***** Finished building loaders *****
Epoch: 1
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 50.51it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 57.97it/s]
[2024-10-05 23:55:24] INFO - Saved Best epoch &amp; Best Model! Loss: [0: 6.591538747151692]
[2024-10-05 23:55:24] INFO - epoch [2/1]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Saved Best epoch &amp; Best Model! Loss: [0: 6.591538747151692]
Epoch: 2
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 80.99it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 75.77it/s]
[2024-10-05 23:55:25] INFO - Saved Best epoch &amp; Best Model! Loss: [1: 6.504086256027222]
[2024-10-05 23:55:25] INFO - epoch [3/2]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Saved Best epoch &amp; Best Model! Loss: [1: 6.504086256027222]
Epoch: 3
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 64.40it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 75.40it/s]
[2024-10-05 23:55:25] INFO - Saved Best epoch &amp; Best Model! Loss: [2: 6.33589752515157]
[2024-10-05 23:55:25] INFO - epoch [4/3]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Saved Best epoch &amp; Best Model! Loss: [2: 6.33589752515157]
Epoch: 4
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 82.87it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 73.20it/s]
[2024-10-05 23:55:26] INFO - Saved Best epoch &amp; Best Model! Loss: [3: 6.244754155476888]
[2024-10-05 23:55:26] INFO - epoch [5/4]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Saved Best epoch &amp; Best Model! Loss: [3: 6.244754155476888]
Epoch: 5
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 62.01it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 61.85it/s]
[2024-10-05 23:55:26] INFO - Saved Best epoch &amp; Best Model! Loss: [4: 6.193502108256022]
[2024-10-05 23:55:26] INFO - epoch [6/5]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Saved Best epoch &amp; Best Model! Loss: [4: 6.193502108256022]
Epoch: 6
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 72.60it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 71.53it/s]
[2024-10-05 23:55:27] INFO - Saved Best epoch &amp; Best Model! Loss: [5: 6.150462706883748]
[2024-10-05 23:55:27] INFO - epoch [7/6]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Saved Best epoch &amp; Best Model! Loss: [5: 6.150462706883748]
Epoch: 7
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 72.78it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 56.47it/s]
[2024-10-05 23:55:28] INFO - Saved Best epoch &amp; Best Model! Loss: [6: 6.140520334243774]
[2024-10-05 23:55:28] INFO - epoch [8/7]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Saved Best epoch &amp; Best Model! Loss: [6: 6.140520334243774]
Epoch: 8
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 81.56it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 73.93it/s]
[2024-10-05 23:55:28] INFO - Saved Best epoch &amp; Best Model! Loss: [7: 6.108221610387166]
[2024-10-05 23:55:28] INFO - epoch [9/8]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Saved Best epoch &amp; Best Model! Loss: [7: 6.108221610387166]
Epoch: 9
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 82.35it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 58.88it/s]
[2024-10-05 23:55:29] INFO - Saved Best epoch &amp; Best Model! Loss: [8: 6.071570634841919]
[2024-10-05 23:55:29] INFO - epoch [10/9]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Saved Best epoch &amp; Best Model! Loss: [8: 6.071570634841919]
Epoch: 10
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 61.95it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 74.50it/s]
[2024-10-05 23:55:29] INFO - Saved Best epoch &amp; Best Model! Loss: [9: 6.054988463719686]
[2024-10-05 23:55:29] INFO - epoch [11/10]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Saved Best epoch &amp; Best Model! Loss: [9: 6.054988463719686]
Epoch: 11
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 68.70it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 74.27it/s]
[2024-10-05 23:55:30] INFO - Saved Best epoch &amp; Best Model! Loss: [10: 6.018951654434204]
[2024-10-05 23:55:30] INFO - epoch [12/11]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Saved Best epoch &amp; Best Model! Loss: [10: 6.018951654434204]
Epoch: 12
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 79.92it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 43.22it/s]
[2024-10-05 23:55:30] INFO - epoch [13/12]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Epoch: 13
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 74.07it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 74.59it/s]
[2024-10-05 23:55:31] INFO - Saved Best epoch &amp; Best Model! Loss: [12: 5.94696323076884]
[2024-10-05 23:55:31] INFO - epoch [14/13]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Saved Best epoch &amp; Best Model! Loss: [12: 5.94696323076884]
Epoch: 14
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 81.14it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 75.39it/s]
[2024-10-05 23:55:31] INFO - epoch [15/14]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Epoch: 15
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 80.57it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 73.52it/s]
[2024-10-05 23:55:32] INFO - Saved Best epoch &amp; Best Model! Loss: [14: 5.918400287628174]
[2024-10-05 23:55:32] INFO - epoch [16/15]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Saved Best epoch &amp; Best Model! Loss: [14: 5.918400287628174]
Epoch: 16
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 75.87it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 73.22it/s]
[2024-10-05 23:55:32] INFO - Saved Best epoch &amp; Best Model! Loss: [15: 5.912964661916097]
[2024-10-05 23:55:32] INFO - epoch [17/16]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Saved Best epoch &amp; Best Model! Loss: [15: 5.912964661916097]
Epoch: 17
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 80.49it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 74.95it/s]
[2024-10-05 23:55:33] INFO - Saved Best epoch &amp; Best Model! Loss: [16: 5.906679630279541]
[2024-10-05 23:55:33] INFO - epoch [18/17]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Saved Best epoch &amp; Best Model! Loss: [16: 5.906679630279541]
Epoch: 18
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 81.55it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 75.80it/s]
[2024-10-05 23:55:33] INFO - Saved Best epoch &amp; Best Model! Loss: [17: 5.902221043904622]
[2024-10-05 23:55:33] INFO - epoch [19/18]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Saved Best epoch &amp; Best Model! Loss: [17: 5.902221043904622]
Epoch: 19
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 80.15it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 74.10it/s]
[2024-10-05 23:55:34] INFO - Saved Best epoch &amp; Best Model! Loss: [18: 5.862451791763306]
[2024-10-05 23:55:34] INFO - epoch [20/19]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Saved Best epoch &amp; Best Model! Loss: [18: 5.862451791763306]
Epoch: 20
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 82.33it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 75.24it/s]
[2024-10-05 23:55:34] INFO - Saved Best epoch &amp; Best Model! Loss: [19: 5.858784993489583]
[2024-10-05 23:55:34] INFO - epoch [21/20]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Saved Best epoch &amp; Best Model! Loss: [19: 5.858784993489583]
Epoch: 21
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 62.82it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 54.80it/s]
[2024-10-05 23:55:35] INFO - Saved Best epoch &amp; Best Model! Loss: [20: 5.832344849904378]
[2024-10-05 23:55:35] INFO - epoch [22/21]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Saved Best epoch &amp; Best Model! Loss: [20: 5.832344849904378]
Epoch: 22
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 60.97it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 69.30it/s]
[2024-10-05 23:55:36] INFO - Saved Best epoch &amp; Best Model! Loss: [21: 5.823706309000651]
[2024-10-05 23:55:36] INFO - epoch [23/22]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Saved Best epoch &amp; Best Model! Loss: [21: 5.823706309000651]
Epoch: 23
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 79.30it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 72.41it/s]
[2024-10-05 23:55:36] INFO - epoch [24/23]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Epoch: 24
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 82.39it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 56.14it/s]
[2024-10-05 23:55:37] INFO - epoch [25/24]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Epoch: 25
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 61.47it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 57.49it/s]
[2024-10-05 23:55:37] INFO - epoch [26/25]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Epoch: 26
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 62.35it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 57.87it/s]
[2024-10-05 23:55:38] INFO - Saved Best epoch &amp; Best Model! Loss: [25: 5.815057992935181]
[2024-10-05 23:55:38] INFO - epoch [27/26]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Saved Best epoch &amp; Best Model! Loss: [25: 5.815057992935181]
Epoch: 27
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 62.89it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 58.52it/s]
[2024-10-05 23:55:38] INFO - Saved Best epoch &amp; Best Model! Loss: [26: 5.779847939809163]
[2024-10-05 23:55:38] INFO - epoch [28/27]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Saved Best epoch &amp; Best Model! Loss: [26: 5.779847939809163]
Epoch: 28
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 62.56it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 58.27it/s]
[2024-10-05 23:55:39] INFO - epoch [29/28]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Epoch: 29
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 55.42it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 53.78it/s]
[2024-10-05 23:55:40] INFO - epoch [30/29]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Epoch: 30
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 62.64it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 58.82it/s]
[2024-10-05 23:55:40] INFO - epoch [31/30]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Epoch: 31
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 63.19it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 56.09it/s]
[2024-10-05 23:55:41] INFO - epoch [32/31]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Epoch: 32
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 59.72it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 59.26it/s]
[2024-10-05 23:55:41] INFO - epoch [33/32]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Epoch: 33
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 62.79it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 57.47it/s]
[2024-10-05 23:55:42] INFO - epoch [34/33]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Epoch: 34
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 61.07it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 59.48it/s]
[2024-10-05 23:55:42] INFO - epoch [35/34]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Epoch: 35
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 62.24it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 58.16it/s]
[2024-10-05 23:55:43] INFO - epoch [36/35]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Epoch: 36
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 62.68it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 55.51it/s]
[2024-10-05 23:55:44] INFO - epoch [37/36]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Epoch: 37
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 79.71it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 55.34it/s]
[2024-10-05 23:55:44] INFO - epoch [38/37]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Epoch: 38
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 61.63it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 58.12it/s]
[2024-10-05 23:55:45] INFO - epoch [39/38]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Epoch: 39
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 62.66it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 75.22it/s]
[2024-10-05 23:55:45] INFO - epoch [40/39]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Epoch: 40
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 81.65it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 60.13it/s]
[2024-10-05 23:55:46] INFO - epoch [41/40]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Epoch: 41
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 81.29it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 78.15it/s]
[2024-10-05 23:55:46] INFO - epoch [42/41]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Epoch: 42
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 81.80it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 56.25it/s]
[2024-10-05 23:55:47] INFO - epoch [43/42]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Epoch: 43
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 59.42it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 53.60it/s]
[2024-10-05 23:55:47] INFO - epoch [44/43]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Epoch: 44
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 59.51it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 59.09it/s]
[2024-10-05 23:55:48] INFO - epoch [45/44]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Epoch: 45
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 61.89it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 48.30it/s]
[2024-10-05 23:55:48] INFO - epoch [46/45]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Epoch: 46
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 60.45it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 58.66it/s]
[2024-10-05 23:55:49] INFO - epoch [47/46]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Epoch: 47
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 63.16it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 58.59it/s]
[2024-10-05 23:55:49] INFO - epoch [48/47]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Epoch: 48
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 62.88it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 57.47it/s]
[2024-10-05 23:55:50] INFO - epoch [49/48]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Epoch: 49
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 61.49it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 50.23it/s]
[2024-10-05 23:55:51] INFO - epoch [50/49]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Epoch: 50
train model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:00&lt;00:00, 56.85it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
test model
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 54.40it/s]
[2024-10-05 23:55:51] INFO - Done!, Best epoch &amp; Best Model! Loss: [26: 5.779847939809163]
[2024-10-05 23:55:51] INFO - Finished Training
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
checkNeighbors.............
Done!, final loss: 5.779847939809163
Best epoch: 26
</pre></div></div>
</div>
</section>
<section id="3.-Inference,-Imputation-and-Evaluation-on-within-spot">
<h2>3. Inference, Imputation and Evaluation on within spot<a class="headerlink" href="#3.-Inference,-Imputation-and-Evaluation-on-within-spot" title="Permalink to this heading"></a></h2>
<p>3.1 Inference: within spot</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dir_name</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;/mnt/lingyu/nfs_share2/Python/FineST/FineST/Finetune/20241006221845787989&#39;
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## You can use the &#39;dir_name&#39; just obtained from the above</span>
<span class="c1">## but here we use the trained &#39;dir_name&#39; before, for paper results repeated</span>

<span class="n">dir_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;FineST/FineST/Finetune/20240125140443830148&#39;</span>
<span class="n">parameter_file_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;FineST/FineST/Parameter/parameters_NPC_P10125.json&#39;</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#####################################################################################</span>
<span class="c1"># main</span>
<span class="c1">#####################################################################################</span>

<span class="c1"># load params</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">parameter_file_path</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>

<span class="c1"># load models</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="n">dir_name</span><span class="p">,</span> <span class="n">parameter_file_path</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">gene_hv</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="c1"># print(&quot;model&quot;, model)</span>

<span class="c1"># load all data</span>
<span class="n">test_loader</span> <span class="o">=</span> <span class="n">build_loaders_inference</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">image_embed_path</span><span class="o">=</span><span class="n">image_embed_path_NPC</span><span class="p">)</span>


<span class="c1"># inference</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running inference tesk...&quot;</span><span class="p">)</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="p">(</span><span class="n">matrix_profile</span><span class="p">,</span>
<span class="n">reconstructed_matrix</span><span class="p">,</span>
<span class="n">recon_ref_adata_image_f2</span><span class="p">,</span>
<span class="n">representation_image_reshape</span><span class="p">,</span>
<span class="n">representation_matrix</span><span class="p">,</span>
<span class="n">projection_image_reshape</span><span class="p">,</span>
<span class="n">projection_matrix</span><span class="p">,</span>
<span class="n">input_image_exp</span><span class="p">,</span>
<span class="n">reconstruction_iamge</span><span class="p">,</span>
<span class="n">reconstructed_matrix_reshaped</span><span class="p">,</span>
<span class="n">input_coord_all</span><span class="p">)</span> <span class="o">=</span> <span class="n">perform_inference</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- </span><span class="si">%s</span><span class="s2"> seconds ---&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>

<span class="c1"># print</span>
<span class="nb">print</span><span class="p">(</span><span class="n">matrix_profile</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">reconstructed_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">recon_ref_adata_image_f2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="c1"># print(&quot;print(reconstructed_matrix_reshaped.shape)&quot;, reconstructed_matrix_reshaped.shape)</span>
<span class="c1"># print(matrix_profile)</span>
<span class="c1"># print(reconstructed_matrix)</span>
<span class="c1"># print(recon_ref_adata_image_f2)</span>
<span class="c1"># print(input_coord_all)</span>

<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running inference tesk DONE!&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
***** Building loaders_inference *****
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
[2024-10-06 22:18:53] INFO - Running inference tesk...
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Finished loading all files
***** Finished building loaders_inference *****
device cuda:0
***** Begin perform_inference: ******
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00,  8.85it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
***** batch_size=adata.shape[0] 不影响 *****
torch.Size([1331, 596])
torch.Size([1331, 16, 384])
1
1
1
***** *****
Finished extractting test data
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

[2024-10-06 22:18:54] INFO - Running inference tesk DONE!
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
--- 0.9351062774658203 seconds ---
(1331, 596)
(1331, 596)
(1331, 596)
</pre></div></div>
</div>
<p>3.2 Inference: All subspot location</p>
<p>3.2.1 All subspot location</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">reconstructed_matrix_reshaped</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">reconstructed_matrix_reshaped</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">16</span><span class="p">)</span>
<span class="n">reconstructed_matrix_reshaped_tensor</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">reshape_latent_image</span><span class="p">(</span><span class="n">reconstructed_matrix_reshaped</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">reconstructed_matrix_reshaped_tensor</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">reconstructed_matrix_reshaped_tensor</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">reconstructed_matrix_reshaped_tensor</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
torch.Size([21296, 596])
1331.0
torch.Size([1331, 16, 596])
torch.Size([16, 596])
torch.Size([21296])
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">spatial_loc</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">spatial_loc</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>


<span class="n">NN</span> <span class="o">=</span> <span class="n">reconstructed_matrix_reshaped_tensor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">NN</span><span class="p">))</span>
<span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">spatial_loc</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">spatial_loc</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>


<span class="c1"># 初始化为整数类型的零矩阵</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">k</span> <span class="o">%</span> <span class="n">N</span>

    <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">N</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">k</span> <span class="o">//</span> <span class="n">N</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">s</span>
        <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span> <span class="o">//</span> <span class="n">N</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c1">## 64-16</span>
    <span class="c1"># C[k - 1, 0] = x - 7 - 7 * 14 + (i - 1) * 14</span>
    <span class="c1"># C[k - 1, 1] = y - 7 - 7 * 14 + (j - 1) * 14</span>
    <span class="c1">## 64-4  -- h=64/4=16 --  x-(h/2)-(4/2-1)*h</span>
    <span class="n">C</span><span class="p">[</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">8</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span>
    <span class="n">C</span><span class="p">[</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="mi">8</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span>

<span class="nb">print</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
10014 10023
(16, 2)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Select the information of the first spot and the first variable</span>
<span class="n">first_spot_first_variable</span> <span class="o">=</span> <span class="n">reconstructed_matrix_reshaped_tensor</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">first_spot_first_variable</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">reconstructed_matrix_reshaped_tensor</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">reconstructed_matrix_reshaped_tensor</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">])</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">))</span>
<span class="n">scatter3</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">C</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">C</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">first_spot_first_variable</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cnt_color</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1800</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;First spot&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(16,)
torch.Size([1331, 16, 596])
tensor([1.3180, 1.3304, 1.3267, 1.2359, 1.2725, 1.2739, 1.2568, 1.2821, 1.2193,
        1.2283, 1.2269, 1.3081, 1.3408, 1.2965, 1.1944, 1.2097],
       device=&#39;cuda:0&#39;, grad_fn=&lt;SelectBackward&gt;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/BRCA_Train2_51_1.png" src="_images/BRCA_Train2_51_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">NN</span> <span class="o">=</span> <span class="n">reconstructed_matrix_reshaped_tensor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">NN</span><span class="p">))</span>

<span class="c1"># Initialize variables all_spot_all_variable and C2</span>
<span class="n">all_spot_all_variable</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">reconstructed_matrix_reshaped_tensor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">reconstructed_matrix_reshaped_tensor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reconstructed_matrix_reshaped_tensor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
<span class="n">C2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">reconstructed_matrix_reshaped_tensor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">reconstructed_matrix_reshaped_tensor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

<span class="c1">## get the sub spot coord</span>
<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">reconstructed_matrix_reshaped_tensor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="c1"># Calculate the coordinates of the 256 positions of the pth spot</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">spatial_loc</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">spatial_loc</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">k</span> <span class="o">%</span> <span class="n">N</span>

        <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">N</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">k</span> <span class="o">//</span> <span class="n">N</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">s</span>
            <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span> <span class="o">//</span> <span class="n">N</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1">## 224</span>
        <span class="c1"># C[k - 1, 0] = x - 7 - 7 * 14 + (i - 1) * 14</span>
        <span class="c1"># C[k - 1, 1] = y - 7 - 7 * 14 + (j - 1) * 14</span>
        <span class="c1">## 64  -- h=64/4=16 --  x-(h/2) - (4/2-1)*h</span>
        <span class="n">C</span><span class="p">[</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">8</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span>
        <span class="n">C</span><span class="p">[</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="mi">8</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span>

    <span class="c1"># Add the coordinates of the 16 positions of the pth spot to C2</span>
    <span class="n">C2</span><span class="p">[</span><span class="n">p</span> <span class="o">*</span> <span class="mi">16</span><span class="p">:(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">C</span>
<span class="nb">print</span><span class="p">(</span><span class="n">C2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1">## get the sub-spot gene expression</span>
<span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">reconstructed_matrix_reshaped_tensor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
    <span class="c1"># Extract the information of the first variable of the pth spot</span>
    <span class="n">all_spot_all_variable</span><span class="p">[:,</span> <span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">reconstructed_matrix_reshaped_tensor</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">q</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>    <span class="c1"># the first variable</span>
<span class="nb">print</span><span class="p">(</span><span class="n">all_spot_all_variable</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(21296, 2)
(21296, 596)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Establish new anndata in sub spot level</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">all_spot_all_variable</span><span class="p">)</span>
<span class="n">adata_spot</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">AnnData</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="n">adata_spot</span><span class="o">.</span><span class="n">var_names</span> <span class="o">=</span> <span class="n">gene_hv</span>
<span class="n">adata_spot</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">C2</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">adata_spot</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">C2</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">adata_spot</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">adata_spot</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">adata_spot</span><span class="o">.</span><span class="n">var_names</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
AnnData object with n_obs × n_vars = 21296 × 596
    obs: &#39;x&#39;, &#39;y&#39;
0         9990
1        10006
2        10022
3        10038
4         9990
         ...
21291     9951
21292     9903
21293     9919
21294     9935
21295     9951
Name: x, Length: 21296, dtype: int64
Index([&#39;TGFB1&#39;, &#39;TGFBR1&#39;, &#39;TGFBR2&#39;, &#39;TGFB2&#39;, &#39;TGFB3&#39;, &#39;ACVR1B&#39;, &#39;ACVR1C&#39;,
       &#39;ACVR1&#39;, &#39;BMP2&#39;, &#39;BMPR1A&#39;,
       ...
       &#39;KDR&#39;, &#39;TREM2&#39;, &#39;SEMA6A&#39;, &#39;SEMA6B&#39;, &#39;SEMA7A&#39;, &#39;PLXNC1&#39;, &#39;SIGLEC1&#39;,
       &#39;THY1&#39;, &#39;VCAM1&#39;, &#39;VSIR&#39;],
      dtype=&#39;object&#39;, length=596)
</pre></div></div>
</div>
<p>3.2.2 Neighbours of all within spot</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">prepare_adata</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">adata_spot</span><span class="p">,</span> <span class="n">C2</span><span class="p">,</span> <span class="n">gene_hv</span><span class="p">):</span>
    <span class="c1"># adata_know: adata (original) 1331 × 596</span>
    <span class="c1"># adata_spot: all subspot 21296 × 596</span>
    <span class="n">adata_know</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">adata_know</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;spatial&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">adata_know</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;spatial&#39;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">x_sudo</span><span class="p">,</span> <span class="n">y_sudo</span> <span class="o">=</span> <span class="n">adata_spot</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">adata_spot</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">x_know</span><span class="p">,</span> <span class="n">y_know</span> <span class="o">=</span> <span class="n">adata_know</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">adata_know</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;X_sudo &amp; x_know:&quot;</span><span class="p">,</span> <span class="n">x_sudo</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">x_know</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>    <span class="c1"># X_sudo &amp; x_know: (17424,) (adata.shape[0],)</span>

    <span class="n">adata_spot</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;spatial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">adata_spot</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">adata_spot</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>

    <span class="n">xlist</span> <span class="o">=</span> <span class="n">C2</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">ylist</span> <span class="o">=</span> <span class="n">C2</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">sudo</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">xlist</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">ylist</span><span class="p">})</span>

    <span class="n">sudo_adata</span> <span class="o">=</span> <span class="n">anndata</span><span class="o">.</span><span class="n">AnnData</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sudo</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">gene_hv</span><span class="p">))))</span>
    <span class="n">sudo_adata</span><span class="o">.</span><span class="n">obs</span> <span class="o">=</span> <span class="n">sudo</span>
    <span class="n">sudo_adata</span><span class="o">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">adata_know</span><span class="o">.</span><span class="n">var</span>

    <span class="k">return</span> <span class="n">adata_know</span><span class="p">,</span> <span class="n">sudo_adata</span><span class="p">,</span> <span class="n">adata_spot</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_know</span><span class="p">,</span> <span class="n">sudo_adata</span><span class="p">,</span> <span class="n">adata_spot</span> <span class="o">=</span> <span class="n">prepare_adata</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">adata_spot</span><span class="p">,</span> <span class="n">C2</span><span class="p">,</span> <span class="n">gene_hv</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">adata_know</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sudo_adata</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
X_sudo &amp; x_know: (21296,) (1331,)
AnnData object with n_obs × n_vars = 1331 × 596
    obs: &#39;in_tissue&#39;, &#39;array_row&#39;, &#39;array_col&#39;, &#39;n_genes_by_counts&#39;, &#39;log1p_n_genes_by_counts&#39;, &#39;total_counts&#39;, &#39;log1p_total_counts&#39;, &#39;pct_counts_in_top_50_genes&#39;, &#39;pct_counts_in_top_100_genes&#39;, &#39;pct_counts_in_top_200_genes&#39;, &#39;pct_counts_in_top_500_genes&#39;, &#39;total_counts_mt&#39;, &#39;log1p_total_counts_mt&#39;, &#39;pct_counts_mt&#39;, &#39;x&#39;, &#39;y&#39;
    var: &#39;gene_ids&#39;, &#39;feature_types&#39;, &#39;genome&#39;, &#39;mt&#39;, &#39;n_cells_by_counts&#39;, &#39;mean_counts&#39;, &#39;log1p_mean_counts&#39;, &#39;pct_dropout_by_counts&#39;, &#39;total_counts&#39;, &#39;log1p_total_counts&#39;, &#39;n_cells&#39;
    uns: &#39;spatial&#39;, &#39;log1p&#39;
    obsm: &#39;spatial&#39;
AnnData object with n_obs × n_vars = 21296 × 596
    obs: &#39;x&#39;, &#39;y&#39;
    var: &#39;gene_ids&#39;, &#39;feature_types&#39;, &#39;genome&#39;, &#39;mt&#39;, &#39;n_cells_by_counts&#39;, &#39;mean_counts&#39;, &#39;log1p_mean_counts&#39;, &#39;pct_dropout_by_counts&#39;, &#39;total_counts&#39;, &#39;log1p_total_counts&#39;, &#39;n_cells&#39;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">nearest_points</span> <span class="o">=</span> <span class="n">find_nearest_point</span><span class="p">(</span><span class="n">adata_spot</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;spatial&#39;</span><span class="p">],</span> <span class="n">adata_know</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;spatial&#39;</span><span class="p">])</span>
<span class="n">nbs</span><span class="p">,</span> <span class="n">nbs_indices</span> <span class="o">=</span> <span class="n">find_nearest_neighbors</span><span class="p">(</span><span class="n">nearest_points</span><span class="p">,</span> <span class="n">adata_know</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;spatial&#39;</span><span class="p">])</span>
<span class="n">distances</span> <span class="o">=</span> <span class="n">calculate_euclidean_distances</span><span class="p">(</span><span class="n">adata_spot</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;spatial&#39;</span><span class="p">],</span> <span class="n">nbs</span><span class="p">)</span>

<span class="c1"># Iterate over each point in sudo_adata</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sudo_adata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="n">dis_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">distances</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">distances</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">dis_tmp</span> <span class="o">**</span> <span class="n">k</span><span class="p">))</span> <span class="o">/</span> <span class="p">((</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">dis_tmp</span> <span class="o">**</span> <span class="n">k</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span>
    <span class="n">sudo_adata</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">adata_know</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">nbs_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">todense</span><span class="p">())</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- </span><span class="si">%s</span><span class="s2"> seconds ---&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
--- 5.0214667320251465 seconds ---
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">A</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">adata_spot</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sudo_adata</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[0.         0.         0.         ... 1.4639113  0.         0.        ]
 [1.5438051  0.90541154 0.90541154 ... 0.90541154 1.5438051  0.551857  ]
 [0.         0.         1.0923328  ... 0.         0.         0.        ]
 ...
 [0.68265146 0.         0.         ... 0.68265146 1.0845934  1.0845934 ]
 [0.         0.         0.         ... 0.         1.2505107  0.        ]
 [0.6407335  0.         0.         ... 0.         1.3066062  0.        ]]
[[1.31799281 0.56362665 1.01991451 ... 1.09909415 2.46734881 1.40222216]
 [1.33040011 0.56309283 1.04158568 ... 1.099581   2.4346807  1.40167749]
 [1.32670617 0.55537564 1.05652225 ... 1.08821797 2.3501575  1.38864398]
 ...
 [1.26423275 0.62541008 0.80414045 ... 1.13703346 3.17277408 1.45104289]
 [1.25009012 0.62731379 0.79174697 ... 1.13240743 3.20413661 1.4498291 ]
 [1.23857868 0.6168173  0.78288484 ... 1.11974406 3.16757846 1.43602562]]
[[0.19212073 0.14295181 0.21724944 ... 0.92930197 0.16669527 0.22734294]
 [0.16373539 0.11892636 0.17475145 ... 1.02403174 0.13173428 0.18747924]
 [0.16464067 0.11652108 0.16633396 ... 1.03570959 0.12368388 0.18222492]
 ...
 [0.42582732 0.05645661 0.         ... 0.13454519 1.20059071 0.08555629]
 [0.42631569 0.05236122 0.         ... 0.12955133 1.20609013 0.08257869]
 [0.38632761 0.0577832  0.         ... 0.14835792 1.19364902 0.09426072]]
</pre></div></div>
</div>
<p>3.2.3 Add two inference data with w1 and w2</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## imputed results</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sudo_adata</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">sudo_adata</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="c1">## inferred results</span>
<span class="nb">print</span><span class="p">(</span><span class="n">adata_spot</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">adata_spot</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0.0 4.4401448861934165
1.4901161193847656e-08 16.816301345825195
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">sudo_adata</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">adata_spot</span><span class="p">)</span>

<span class="c1">############################################</span>
<span class="c1">## using the weight and add</span>
<span class="c1">## adata_spot: inferred results</span>
<span class="c1">## sudo_adata: imputed results</span>
<span class="c1">############################################</span>

<span class="n">w1</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">weight_impt_data</span> <span class="o">=</span> <span class="n">w1</span><span class="o">*</span><span class="n">adata_spot</span><span class="o">.</span><span class="n">X</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">w1</span><span class="p">)</span><span class="o">*</span><span class="n">sudo_adata</span><span class="o">.</span><span class="n">X</span>
<span class="n">adata_impt</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">AnnData</span><span class="p">(</span><span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">weight_impt_data</span><span class="p">))</span>

<span class="n">adata_impt</span><span class="o">.</span><span class="n">var_names</span> <span class="o">=</span> <span class="n">gene_hv</span>
<span class="n">adata_impt</span><span class="o">.</span><span class="n">obs</span> <span class="o">=</span> <span class="n">adata_spot</span><span class="o">.</span><span class="n">obs</span>
<span class="nb">print</span><span class="p">(</span><span class="n">adata_impt</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">adata_impt</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
AnnData object with n_obs × n_vars = 21296 × 596
    obs: &#39;x&#39;, &#39;y&#39;
    var: &#39;gene_ids&#39;, &#39;feature_types&#39;, &#39;genome&#39;, &#39;mt&#39;, &#39;n_cells_by_counts&#39;, &#39;mean_counts&#39;, &#39;log1p_mean_counts&#39;, &#39;pct_dropout_by_counts&#39;, &#39;total_counts&#39;, &#39;log1p_total_counts&#39;, &#39;n_cells&#39;
AnnData object with n_obs × n_vars = 21296 × 596
    obs: &#39;x&#39;, &#39;y&#39;
    obsm: &#39;spatial&#39;
AnnData object with n_obs × n_vars = 21296 × 596
    obs: &#39;x&#39;, &#39;y&#39;
0         9990
1        10006
2        10022
3        10038
4         9990
         ...
21291     9951
21292     9903
21293     9919
21294     9935
21295     9951
Name: x, Length: 21296, dtype: int64
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">reconstructed_matrix_reshaped</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">data_impt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">weight_impt_data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data_impt</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data_impt</span><span class="p">[:</span><span class="mi">10</span><span class="p">])</span>

<span class="n">_</span><span class="p">,</span> <span class="n">data_impt_reshape</span> <span class="o">=</span> <span class="n">reshape_latent_image</span><span class="p">(</span><span class="n">data_impt</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data_impt_reshape</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data_impt_reshape</span><span class="p">[:</span><span class="mi">10</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
torch.Size([21296, 596])
torch.Size([21296, 596])
tensor([[0.7551, 0.3533, 0.6186,  ..., 1.0142, 1.3170, 0.8148],
        [0.7471, 0.3410, 0.6082,  ..., 1.0618, 1.2832, 0.7946],
        [0.7457, 0.3359, 0.6114,  ..., 1.0620, 1.2369, 0.7854],
        ...,
        [0.7225, 0.3455, 0.5528,  ..., 1.0732, 1.3578, 0.7880],
        [0.6908, 0.3626, 0.4906,  ..., 1.0599, 1.5304, 0.7918],
        [0.6603, 0.3263, 0.4673,  ..., 1.1522, 1.4382, 0.7454]],
       dtype=torch.float64)
torch.Size([1331, 596])
tensor([[0.7114, 0.3459, 0.5409,  ..., 1.0766, 1.3782, 0.7821],
        [1.1502, 0.6222, 0.7276,  ..., 0.9088, 1.9652, 0.9071],
        [0.6043, 0.3282, 0.7858,  ..., 0.5805, 1.4134, 0.6444],
        ...,
        [0.7713, 0.4575, 0.5606,  ..., 0.9314, 2.1450, 1.0506],
        [0.9161, 0.4793, 0.4842,  ..., 0.8907, 1.7709, 0.9171],
        [0.7137, 0.3250, 0.8277,  ..., 0.8162, 1.6566, 0.7935]],
       dtype=torch.float64)
</pre></div></div>
</div>
<p>3.3 Visualization: selected gene</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_gene_data_scale</span><span class="p">(</span><span class="n">spatial_loc</span><span class="p">,</span> <span class="n">genedata</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
    <span class="n">normalized_data</span> <span class="o">=</span> <span class="n">genedata</span>
    <span class="n">normalized_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">genedata</span> <span class="o">-</span> <span class="n">genedata</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="n">genedata</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">genedata</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="n">scatter</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">spatial_loc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">spatial_loc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">normalized_data</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cnt_color</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">scatter</span>

<span class="c1">##########################################################################################</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">gene</span> <span class="o">=</span> <span class="s2">&quot;CD70&quot;</span>

<span class="c1"># Orignal test data</span>
<span class="n">orignal_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">matrix_profile</span><span class="p">)</span>
<span class="n">orignal_matrix</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">gene_hv</span>
<span class="n">genedata1</span> <span class="o">=</span> <span class="n">orignal_matrix</span><span class="p">[[</span><span class="n">gene</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">scatter1</span> <span class="o">=</span> <span class="n">plot_gene_data_scale</span><span class="p">(</span><span class="n">spatial_loc</span><span class="p">,</span> <span class="n">genedata1</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">gene</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; Expression: Orignal&quot;</span><span class="p">,</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="c1">## Imputed test data</span>
<span class="n">imputed_matrix_test_exp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data_impt_reshape</span><span class="p">)</span>
<span class="n">imputed_matrix_test_exp</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">gene_hv</span>
<span class="nb">print</span><span class="p">(</span><span class="n">imputed_matrix_test_exp</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">genedata2</span> <span class="o">=</span> <span class="n">imputed_matrix_test_exp</span><span class="p">[[</span><span class="n">gene</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">scatter2</span> <span class="o">=</span> <span class="n">plot_gene_data_scale</span><span class="p">(</span><span class="n">spatial_loc</span><span class="p">,</span> <span class="n">genedata2</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">gene</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; Expression: Imputation&quot;</span><span class="p">,</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="c1"># ## Reconstructed_f2 test data</span>
<span class="c1"># reconstruction_f2_reshape_pd = pd.DataFrame(recon_ref_adata_image_f2)</span>
<span class="c1"># reconstruction_f2_reshape_pd.columns = gene_hv</span>
<span class="c1"># print(reconstruction_f2_reshape_pd.shape)</span>
<span class="c1"># genedata3 = reconstruction_f2_reshape_pd[[gene]].to_numpy()</span>
<span class="c1"># scatter3 = plot_gene_data_scale(spatial_loc, genedata3, str(gene)+&quot; Expression: Reconstructed F2&quot;, axes[2])</span>

<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scatter1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(1331, 596)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/BRCA_Train2_64_1.png" src="_images/BRCA_Train2_64_1.png" />
</div>
</div>
<p>3.4 Correlation: selected gene</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">pearsonr</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">r2_score</span>

<span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">font_scale</span><span class="o">=</span><span class="mf">1.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">plot_correlation</span><span class="p">(</span><span class="n">genedata1</span><span class="p">,</span> <span class="n">genedata2</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>

    <span class="n">g</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">JointGrid</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">genedata1</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">genedata2</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">space</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">plot_joint</span><span class="p">(</span><span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">)</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">plot_marginals</span><span class="p">(</span><span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">,</span> <span class="n">shade</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">)</span>

    <span class="n">pearson_corr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">pearsonr</span><span class="p">(</span><span class="n">genedata1</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">genedata2</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">cosine_sim</span> <span class="o">=</span> <span class="n">cosine_similarity</span><span class="p">(</span><span class="n">genedata1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">genedata2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">lr</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
    <span class="n">lr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">genedata1</span><span class="p">,</span> <span class="n">genedata2</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">ax_joint</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">())</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">lr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">g</span><span class="o">.</span><span class="n">ax_joint</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>

    <span class="n">r2_value</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">genedata2</span><span class="p">,</span> <span class="n">lr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">genedata1</span><span class="p">))</span>

    <span class="n">g</span><span class="o">.</span><span class="n">ax_joint</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Pearson Correlation: </span><span class="si">{</span><span class="n">pearson_corr</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s1">Cosine Similarity: </span><span class="si">{</span><span class="n">cosine_sim</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s1">R²: </span><span class="si">{</span><span class="n">r2_value</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="n">g</span><span class="o">.</span><span class="n">ax_joint</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Original Expression&#39;</span><span class="p">)</span>
    <span class="n">g</span><span class="o">.</span><span class="n">ax_joint</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
    <span class="n">g</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gene</span> <span class="o">=</span> <span class="s2">&quot;CD70&quot;</span>
<span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Predicted Expression&quot;</span>

<span class="n">genedata1</span> <span class="o">=</span> <span class="n">orignal_matrix</span><span class="p">[[</span><span class="n">gene</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">genedata2</span> <span class="o">=</span> <span class="n">imputed_matrix_test_exp</span><span class="p">[[</span><span class="n">gene</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

<span class="n">plot_correlation</span><span class="p">(</span><span class="n">genedata1</span><span class="p">,</span> <span class="n">genedata2</span><span class="p">,</span> <span class="s1">&#39;Reconstructed Expression&#39;</span><span class="p">,</span> <span class="n">gene</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/BRCA_Train2_67_0.png" src="_images/BRCA_Train2_67_0.png" />
</div>
</div>
<p>3.5 Correlation: Spot</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[49]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">calculate_statistics</span><span class="p">(</span><span class="n">matrix1</span><span class="p">,</span> <span class="n">matrix2</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">matrix1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">matrix2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="c1">## pearson</span>
    <span class="n">mean_pearson_corr</span> <span class="o">=</span> <span class="n">calculate_correlation_infer</span><span class="p">(</span><span class="n">matrix1</span><span class="p">,</span> <span class="n">matrix2</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;pearson&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Mean Pearson correlation coefficient--</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">mean_pearson_corr</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1">## spearman</span>
    <span class="n">mean_spearman_corr</span> <span class="o">=</span> <span class="n">calculate_correlation_infer</span><span class="p">(</span><span class="n">matrix1</span><span class="p">,</span> <span class="n">matrix2</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;spearman&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Mean Spearman correlation coefficient--</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">mean_spearman_corr</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1">## cosine_similarity_row</span>
    <span class="n">cosine_sim</span> <span class="o">=</span> <span class="n">calculate_cosine_similarity_row</span><span class="p">(</span><span class="n">matrix1</span><span class="p">,</span> <span class="n">matrix2</span><span class="p">)</span>
    <span class="n">cosine_sim_per_sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cosine_sim</span><span class="p">)</span>
    <span class="n">average_cosine_similarity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cosine_sim_per_sample</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Average cosine similarity--</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">average_cosine_similarity</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1">## Correlation -- adata.shape[0] sample</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running correlation task...&quot;</span><span class="p">)</span>

<span class="c1">## reconstructed by f2 (recon_ref_adata_image_f2)</span>
<span class="n">calculate_statistics</span><span class="p">(</span><span class="n">matrix_profile</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">imputed_matrix_test_exp</span><span class="p">),</span> <span class="s1">&#39;reconf2&#39;</span><span class="p">)</span>

<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running correlation task DINE!&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
[2024-10-06 22:23:19] INFO - Running correlation task...
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(1331, 596)
(1331, 596)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
[2024-10-06 22:23:20] INFO - Mean Pearson correlation coefficient--reconf2: 0.8534651812923978
[2024-10-06 22:23:21] INFO - Mean Spearman correlation coefficient--reconf2: 0.6092512988048214
[2024-10-06 22:23:21] INFO - Average cosine similarity--reconf2: 0.8712951105022001
[2024-10-06 22:23:21] INFO - Running correlation task DINE!
</pre></div></div>
</div>
<p>3.6 Correlation: Gene</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[50]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running Gene Correlation task...&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">calculate_statistics_gene</span><span class="p">(</span><span class="n">matrix1</span><span class="p">,</span> <span class="n">matrix2</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">matrix1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">matrix2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="n">mean_pearson_corr</span> <span class="o">=</span> <span class="n">calculate_correlation_infer_gene</span><span class="p">(</span><span class="n">matrix1</span><span class="p">,</span> <span class="n">matrix2</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;pearson&quot;</span><span class="p">)</span>
    <span class="c1"># print(f&quot;Mean Pearson correlation coefficient--{label}: {mean_pearson_corr:.4f}&quot;)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Mean Pearson correlation coefficient--</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">mean_pearson_corr</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">mean_spearman_corr</span> <span class="o">=</span> <span class="n">calculate_correlation_infer_gene</span><span class="p">(</span><span class="n">matrix1</span><span class="p">,</span> <span class="n">matrix2</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;spearman&quot;</span><span class="p">)</span>
    <span class="c1"># print(f&quot;Mean Spearman correlation coefficient--{label}: {mean_spearman_corr:.4f}&quot;)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Mean Spearman correlation coefficient--</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">mean_spearman_corr</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">cosine_sim</span> <span class="o">=</span> <span class="n">calculate_cosine_similarity_col</span><span class="p">(</span><span class="n">matrix1</span><span class="p">,</span> <span class="n">matrix2</span><span class="p">)</span>
    <span class="n">cosine_sim_per_sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cosine_sim</span><span class="p">)</span>
    <span class="n">average_cosine_similarity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cosine_sim_per_sample</span><span class="p">)</span>

    <span class="c1"># print(f&quot;Average cosine similarity--{label}: {average_cosine_similarity:.4f}&quot;)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Average cosine similarity--</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">average_cosine_similarity</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="c1">## reconstructed by f2</span>
<span class="c1">####################################</span>
<span class="n">calculate_statistics_gene</span><span class="p">(</span><span class="n">matrix_profile</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">imputed_matrix_test_exp</span><span class="p">),</span> <span class="s1">&#39;reconf2&#39;</span><span class="p">)</span>

<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running Gene Correlation task DINE!&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
[2024-10-06 22:23:26] INFO - Running Gene Correlation task...
[2024-10-06 22:23:26] INFO - Mean Pearson correlation coefficient--reconf2: 0.8845136777311444
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(1331, 596)
(1331, 596)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
[2024-10-06 22:23:27] INFO - Mean Spearman correlation coefficient--reconf2: 0.5380078136125479
[2024-10-06 22:23:27] INFO - Average cosine similarity--reconf2: 0.6074921416885803
[2024-10-06 22:23:27] INFO - Running Gene Correlation task DINE!
</pre></div></div>
</div>
<p>3.7 Correlation: Spot and Gene</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[51]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">corr_spot</span> <span class="o">=</span> <span class="n">calculate_correlation_spot</span><span class="p">(</span><span class="n">matrix_profile</span><span class="p">,</span> <span class="n">data_impt_reshape</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;pearson&#39;</span><span class="p">)</span>
<span class="n">mean_corr_spot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">corr_spot</span><span class="p">)</span>
<span class="n">corr_gene</span> <span class="o">=</span> <span class="n">calculate_correlation_gene</span><span class="p">(</span><span class="n">matrix_profile</span><span class="p">,</span> <span class="n">data_impt_reshape</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;pearson&#39;</span><span class="p">)</span>
<span class="c1">## avoid nan</span>
<span class="n">corr_gene</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">corr_gene</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">mean_corr_gene</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">corr_gene</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">mean_corr_spot</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">mean_corr_gene</span><span class="p">)</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;Type&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="s1">&#39;corr_spot&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">corr_spot</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="s1">&#39;corr_gene&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">corr_gene</span><span class="p">))]),</span>
    <span class="s1">&#39;mean_corr&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">corr_spot</span><span class="p">,</span> <span class="n">corr_gene</span><span class="p">])</span>
<span class="p">})</span>


<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.family&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;sans-serif&#39;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">14</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;Type&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;mean_corr&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;Set2&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Pearson Correlation&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;bottom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">1.5</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_dpi</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
<span class="c1"># plt.savefig(&quot;NPC_PersonCor_spot_gene.pdf&quot;, format=&quot;pdf&quot;)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0.8534651812923978
0.8845136777311444
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/BRCA_Train2_73_1.png" src="_images/BRCA_Train2_73_1.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[52]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## save adata</span>
<span class="c1"># patientxy = &#39;patient1&#39;</span>
<span class="c1"># adata_impt.write_h5ad(str(path)+&#39;FineST/FineST/Dataset/ImputData/&#39;+str(patientxy)+&#39;/&#39;+str(patientxy)+&#39;_adata.h5ad&#39;)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[132]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">orignal_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">imputed_matrix_test_exp</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">reconstruction_f2_reshape_pd_betwn</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(1331, 596)
(1331, 596)
(3708, 596)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[134]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## add data in spot</span>
<span class="n">data_spot_pixel</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">imputed_matrix_test_exp</span><span class="p">,</span> <span class="n">reconstruction_f2_reshape_pd_betwn</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;data_spot_pixel shape:&quot;</span><span class="p">,</span> <span class="n">data_spot_pixel</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1">## add coord in pixel</span>
<span class="n">cord_spot_pixel</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">spatial_loc</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">spatial_loc_add</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">cord_spot_pixel</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;cord_spot_pixel shape:&quot;</span><span class="p">,</span> <span class="n">cord_spot_pixel</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1">## plot</span>
<span class="n">gene</span> <span class="o">=</span> <span class="s1">&#39;CD70&#39;</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="n">plot</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">cord_spot_pixel</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">cord_spot_pixel</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">data_spot_pixel</span><span class="p">[</span><span class="n">gene</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cnt_color</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">gene</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; Expression: Pixel ALL&#39;</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">plot</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
<span class="c1"># plt.savefig(str(gene)+&quot;P1_pixel.pdf&quot;, format=&quot;pdf&quot;)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_dpi</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
data_spot_pixel shape: (5039, 596)
cord_spot_pixel shape: (5039, 2)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/BRCA_Train2_76_1.png" src="_images/BRCA_Train2_76_1.png" />
</div>
</div>
</section>
<section id="4.-Inference-model-for-%22within-spot%22-and-%22between-spot%22">
<h2>4. Inference model for “within spot” and “between spot”<a class="headerlink" href="#4.-Inference-model-for-%22within-spot%22-and-%22between-spot%22" title="Permalink to this heading"></a></h2>
<p>4.1 Load trained model parameters</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[53]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dir_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;FineST/FineST/Finetune/20240125140443830148&#39;</span>
<span class="n">parameter_file_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;FineST/FineST/Parameter/parameters_NPC_P10125.json&#39;</span>
</pre></div>
</div>
</div>
<p>4.2 Load within spot &amp; between spot image feature</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[54]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#########################################</span>
<span class="c1"># Order to get &#39;position_order_all.csv&#39;</span>
<span class="c1">#########################################</span>

<span class="k">def</span> <span class="nf">process_file_paths</span><span class="p">(</span><span class="n">file_paths</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="n">file_paths</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">file_paths</span><span class="p">:</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">file_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="o">==</span> <span class="s1">&#39;BRCAhuman&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">file_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">filename</span><span class="p">)):</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])])</span>
            <span class="k">elif</span> <span class="n">file_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;NEW&#39;</span><span class="p">):</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.pth&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="k">elif</span> <span class="n">filename</span> <span class="o">==</span> <span class="s1">&#39;Patient1&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">file_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;AH&#39;</span><span class="p">):</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])])</span>
            <span class="k">elif</span> <span class="n">file_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;NEW&#39;</span><span class="p">):</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">parts</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.pth&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]])</span>
    <span class="k">return</span> <span class="n">data</span>

<span class="c1">#############################</span>
<span class="c1"># Get file paths</span>
<span class="c1">#############################</span>
<span class="c1">## add coords for each .pth file</span>
<span class="n">file_paths_spot</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;NPC/Data/stdata/ZhuoLiang/LLYtest/AH_Patient1_pth_64_16/&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">file_paths_spot</span><span class="p">))</span>
<span class="n">file_paths_between_spot</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;NPC/Data/stdata/ZhuoLiang/LLYtest/NEW_AH_Patient1_pth_64_16/&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">file_paths_between_spot</span><span class="p">))</span>
<span class="c1">## Merge, sort and process file paths</span>
<span class="n">file_paths_all</span> <span class="o">=</span> <span class="n">file_paths_spot</span> <span class="o">+</span> <span class="n">file_paths_between_spot</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">file_paths_all</span><span class="p">))</span>

<span class="c1">#########################################################</span>
<span class="c1"># Merge, sort and process file paths</span>
<span class="c1">#########################################################</span>
<span class="n">data_all</span> <span class="o">=</span> <span class="n">process_file_paths</span><span class="p">(</span><span class="n">file_paths_all</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;Patient1&#39;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data_all</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Part_3&#39;</span><span class="p">,</span> <span class="s1">&#39;Part_4&#39;</span><span class="p">])</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Part_3&#39;</span><span class="p">:</span> <span class="s1">&#39;pixel_y&#39;</span><span class="p">,</span> <span class="s1">&#39;Part_4&#39;</span><span class="p">:</span> <span class="s1">&#39;pixel_x&#39;</span><span class="p">})[[</span><span class="s1">&#39;pixel_x&#39;</span><span class="p">,</span> <span class="s1">&#39;pixel_y&#39;</span><span class="p">]]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="n">position_order_between_spot</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s2">&quot;pixel_y&quot;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;pixel_y&#39;</span><span class="p">],</span>
    <span class="s2">&quot;pixel_x&quot;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;pixel_x&#39;</span><span class="p">]</span>
<span class="p">})</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1331
3708
5039
     pixel_x pixel_y
0      10023   10014
1       9649   10015
2       9276   10016
3       7783   10020
4       7410   10021
...      ...     ...
5034  3023.5  9978.0
5035  2836.5  9978.5
5036  2650.0  9979.0
5037  2277.0  9980.0
5038  2090.5  9980.5

[5039 rows x 2 columns]
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[55]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## save all spots</span>
<span class="c1"># position_order_between_spot.to_csv(str(path)+&quot;FineST/FineST/Dataset/NPC/ContrastP1geneLR/position_order_all.csv&quot;, index=False, header=False)</span>
</pre></div>
</div>
</div>
<p>4.3 Load within &amp; between spot gene expression data</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[56]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">build_loaders_image_all</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>

    <span class="n">setup_seed</span><span class="p">(</span><span class="mi">666</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;***** Building loaders_inference between spot *****&quot;</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">glob</span>
    <span class="n">file_paths_spot</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;NPC/Data/stdata/ZhuoLiang/LLYtest/AH_Patient1_pth_64_16/*.pth&#39;</span><span class="p">)</span>
    <span class="n">file_paths_between_spot</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;NPC/Data/stdata/ZhuoLiang/LLYtest/NEW_AH_Patient1_pth_64_16/*.pth&#39;</span><span class="p">)</span>
    <span class="n">image_paths</span> <span class="o">=</span> <span class="n">file_paths_spot</span> <span class="o">+</span> <span class="n">file_paths_between_spot</span>
    <span class="n">image_paths</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

    <span class="n">dataset</span> <span class="o">=</span> <span class="n">DatasetCreatImageBetweenSpot</span><span class="p">(</span>
        <span class="n">image_paths</span><span class="o">=</span><span class="n">image_paths</span><span class="p">,</span>
        <span class="n">spatial_pos_path</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;FineST/FineST/Dataset/NPC/ContrastP1geneLR/position_order_all.csv&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">all_dataset</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;***** Finished building loaders_inference between spot *****&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">all_dataset</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[57]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_dataset</span> <span class="o">=</span> <span class="n">build_loaders_image_all</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">file_paths_all</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;all_dataset:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">all_dataset</span><span class="p">)</span>

<span class="n">input_image_all</span><span class="p">,</span> <span class="n">input_coord_all</span> <span class="o">=</span> <span class="n">extract_test_data_image_between_spot</span><span class="p">(</span><span class="n">all_dataset</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;input_image_all:&quot;</span><span class="p">,</span> <span class="n">input_image_all</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;input_coord_all:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_coord_all</span><span class="p">))</span>
<span class="c1"># print(input_image_all)</span>
<span class="c1"># print(input_coord_all)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
***** Building loaders_inference between spot *****
Finished loading all files
***** Finished building loaders_inference between spot *****
all_dataset:
 &lt;torch.utils.data.dataloader.DataLoader object at 0x7ffa1c0f5340&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00,  2.77it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
***** batch_size=adata.shape[0] *****
torch.Size([5039, 16, 384])
1
***** *****
Finished extractting image_between_spot data
input_image_all: torch.Size([5039, 16, 384])
input_coord_all: 1
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<p>4.4 Load the trained model to infer all spots</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[58]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#####################################################################################</span>
<span class="c1"># main</span>
<span class="c1">#####################################################################################</span>

<span class="c1"># load params</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">parameter_file_path</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>

<span class="c1"># load models</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="n">dir_name</span><span class="p">,</span> <span class="n">parameter_file_path</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">gene_hv</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="c1"># print(&quot;model&quot;, model)</span>

<span class="c1">## load between spots data</span>
<span class="n">test_loader</span> <span class="o">=</span> <span class="n">build_loaders_image_all</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">file_paths_all</span><span class="p">))</span>

<span class="c1">## inference</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running inference tesk between spot...&quot;</span><span class="p">)</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="p">(</span><span class="n">recon_ref_adata_image_f2</span><span class="p">,</span>
<span class="n">reconstructed_matrix_reshaped</span><span class="p">,</span>
<span class="n">representation_image_reshape_between_spot</span><span class="p">,</span>
<span class="n">input_image_exp_between_spot</span><span class="p">,</span>
<span class="n">input_coord_all</span><span class="p">)</span> <span class="o">=</span> <span class="n">perform_inference_image_between_spot</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- </span><span class="si">%s</span><span class="s2"> seconds ---&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>

<span class="c1">## print</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;recon_ref_adata_image_f2:&quot;</span><span class="p">,</span> <span class="n">recon_ref_adata_image_f2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="c1"># print(&quot;recon_ref_adata_image_f2:\n&quot;, recon_ref_adata_image_f2)</span>
<span class="c1"># print(&quot;input_coord_all:\n&quot;, input_coord_all)</span>

<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running inference tesk between spot DONE!&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
***** Building loaders_inference between spot *****
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
[2024-10-06 22:24:34] INFO - Running inference tesk between spot...
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Finished loading all files
***** Finished building loaders_inference between spot *****
device cuda:0
***** Begin perform_inference: ******
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00,  4.37it/s]
[2024-10-06 22:24:35] INFO - Running inference tesk between spot DONE!
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
***** batch_size=adata.shape[0] *****
torch.Size([5039, 16, 384])
1
***** *****
Finished extractting image_between_spot data
--- 0.28581905364990234 seconds ---
recon_ref_adata_image_f2: (5039, 596)
</pre></div></div>
</div>
<p>4.5 Visualization all spots</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[59]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gene</span> <span class="o">=</span> <span class="s2">&quot;CD70&quot;</span>
<span class="c1">## Reconstructed_f2 test data</span>
<span class="n">reconstruction_f2_reshape_pd_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">recon_ref_adata_image_f2</span><span class="p">)</span>
<span class="n">reconstruction_f2_reshape_pd_all</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">gene_hv</span>
<span class="n">genedata3</span> <span class="o">=</span> <span class="n">reconstruction_f2_reshape_pd_all</span><span class="p">[[</span><span class="n">gene</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">genedata3</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">reconstructed_matrix_test_arr</span> <span class="o">=</span> <span class="n">recon_ref_adata_image_f2</span><span class="o">.</span><span class="n">T</span>
<span class="nb">print</span><span class="p">(</span><span class="n">reconstructed_matrix_test_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(5039, 1)
(596, 5039)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[60]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_and_check_duplicates</span><span class="p">(</span><span class="n">input_coord_all</span><span class="p">):</span>

    <span class="n">tensor_1</span> <span class="o">=</span> <span class="n">input_coord_all</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">tensor_2</span> <span class="o">=</span> <span class="n">input_coord_all</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">input_coord_all_concat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">tensor_1</span><span class="p">,</span> <span class="n">tensor_2</span><span class="p">))</span>
    <span class="n">spatial_loc</span> <span class="o">=</span> <span class="n">input_coord_all_concat</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

    <span class="c1"># Find unique rows and their counts</span>
    <span class="n">unique_rows</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">spatial_loc</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># Check if there are any duplicate rows</span>
    <span class="n">duplicate_rows</span> <span class="o">=</span> <span class="p">(</span><span class="n">counts</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Are there any duplicate rows? :&quot;</span><span class="p">,</span> <span class="n">duplicate_rows</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">spatial_loc</span>

<span class="n">spatial_loc_all</span> <span class="o">=</span> <span class="n">process_and_check_duplicates</span><span class="p">(</span><span class="n">input_coord_all</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">spatial_loc_all</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Are there any duplicate rows? : False
[[10014.  10023. ]
 [10015.   9649. ]
 [10016.   9276. ]
 ...
 [ 9979.   2650. ]
 [ 9980.   2277. ]
 [ 9980.5  2090.5]]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[61]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_gene_data_dot</span><span class="p">(</span><span class="n">spatial_loc</span><span class="p">,</span> <span class="n">genedata</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
    <span class="n">normalized_data</span> <span class="o">=</span> <span class="n">genedata</span>
    <span class="c1"># normalized_data = (genedata - genedata.min()) / (genedata.max() - genedata.min())</span>
    <span class="n">scatter</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">spatial_loc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">spatial_loc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">normalized_data</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cnt_color</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">scatter</span>

<span class="c1">##########################################################################################</span>
<span class="n">gene</span> <span class="o">=</span> <span class="s2">&quot;CD70&quot;</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="n">genedata3</span> <span class="o">=</span> <span class="n">reconstruction_f2_reshape_pd_all</span><span class="p">[[</span><span class="n">gene</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;genedata3: &quot;</span><span class="p">,</span> <span class="n">genedata3</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">scatter3</span> <span class="o">=</span> <span class="n">plot_gene_data_dot</span><span class="p">(</span><span class="n">spatial_loc_all</span><span class="p">,</span> <span class="n">genedata3</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">gene</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; Expression: all subspot&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scatter3</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
genedata3:  (5039, 1)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/BRCA_Train2_91_1.png" src="_images/BRCA_Train2_91_1.png" />
</div>
</div>
<p>4.6 Visualization all sub-spots</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[62]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">reconstructed_matrix_reshaped</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">reconstructed_matrix_reshaped</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">16</span><span class="p">)</span>
<span class="n">reconstructed_matrix_reshaped_tensor</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">reshape_latent_image</span><span class="p">(</span><span class="n">reconstructed_matrix_reshaped</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">reconstructed_matrix_reshaped_tensor</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>


<span class="c1">################################################################################################</span>
<span class="c1"># Given a gene name, find the column index of the gene in the DataFrame</span>
<span class="c1">################################################################################################</span>
<span class="n">gene</span> <span class="o">=</span> <span class="s1">&#39;CD70&#39;</span>
<span class="n">column_index</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">gene</span><span class="p">)</span>
<span class="n">column_index</span>


<span class="k">def</span> <span class="nf">calculate_coordinates</span><span class="p">(</span><span class="n">spot_index</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="c1">## used for all subspot: torch.Size([19732, 16, 1543])</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">k</span> <span class="o">%</span> <span class="n">N</span>
        <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">N</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">k</span> <span class="o">//</span> <span class="n">N</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">s</span>
            <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span> <span class="o">//</span> <span class="n">N</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">C</span><span class="p">[</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">8</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span>
        <span class="n">C</span><span class="p">[</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="mi">8</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span>

        <span class="c1">## 224</span>
        <span class="c1"># C[k - 1, 0] = x - 7 - 7 * 14 + (i - 1) * 14</span>
        <span class="c1"># C[k - 1, 1] = y - 7 - 7 * 14 + (j - 1) * 14</span>
        <span class="c1">## 64  -- h=64/4=16 --  x-(h/2) - (4/2-1)*h</span>
        <span class="n">C</span><span class="p">[</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">8</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span>
        <span class="n">C</span><span class="p">[</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="mi">8</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span>
    <span class="k">return</span> <span class="n">C</span>


<span class="n">num_variables</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">reconstructed_matrix_reshaped</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">16</span><span class="p">)</span>
<span class="n">num_coordinates</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">reconstructed_matrix_reshaped</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">all_spot_all_variable</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_variables</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
<span class="n">C2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_coordinates</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>


<span class="n">NN</span> <span class="o">=</span> <span class="n">reconstructed_matrix_reshaped_tensor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">NN</span><span class="p">))</span>

<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_variables</span><span class="p">):</span>
    <span class="n">spot_first_variable</span> <span class="o">=</span> <span class="n">reconstructed_matrix_reshaped_tensor</span><span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="p">:,</span> <span class="n">column_index</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">all_spot_all_variable</span><span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">spot_first_variable</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">spatial_loc_all</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">spatial_loc_all</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">calculate_coordinates</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="n">C2</span><span class="p">[</span><span class="n">p</span> <span class="o">*</span> <span class="mi">16</span><span class="p">:(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">C</span>

<span class="nb">print</span><span class="p">(</span><span class="n">C2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">C2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
torch.Size([80624, 596])
5039.0
torch.Size([5039, 16, 596])
(80624, 2)
[[ 9990  9999]
 [10006  9999]
 [10022  9999]
 ...
 [ 9972  2114]
 [ 9988  2114]
 [10004  2114]]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[63]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">12.5</span><span class="p">,</span> <span class="mf">10.5</span><span class="p">))</span>
<span class="n">plot</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">C2</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">C2</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">all_spot_all_variable</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cnt_color</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">gene</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; Expression: Reconstructed_f2 Pixel&#39;</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">plot</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
<span class="c1"># plt.savefig(&quot;P1_pixel.pdf&quot;, format=&quot;pdf&quot;)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_dpi</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/BRCA_Train2_94_0.png" src="_images/BRCA_Train2_94_0.png" />
</div>
</div>
<p>4.7 All subspt location</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[64]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">reconstructed_matrix_reshaped_tensor</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">reconstructed_matrix_reshaped_tensor</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">reconstructed_matrix_reshaped_tensor</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
torch.Size([5039, 16, 596])
torch.Size([16, 596])
torch.Size([80624])
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[65]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialize variables all_spot_all_variable and C2</span>
<span class="n">all_spot_all_variable_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">reconstructed_matrix_reshaped_tensor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">reconstructed_matrix_reshaped_tensor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                      <span class="n">reconstructed_matrix_reshaped_tensor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

<span class="c1"># get the sub-spot gene expression</span>
<span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">reconstructed_matrix_reshaped_tensor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
    <span class="c1"># Extract the information of the first variable of the pth spot</span>
    <span class="n">all_spot_all_variable_all</span><span class="p">[:,</span> <span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">reconstructed_matrix_reshaped_tensor</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">q</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>    <span class="c1"># the first variable</span>
<span class="nb">print</span><span class="p">(</span><span class="n">all_spot_all_variable_all</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Create AnnData object</span>
<span class="n">adata_spot_all</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">AnnData</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">all_spot_all_variable_all</span><span class="p">))</span>
<span class="n">adata_spot_all</span><span class="o">.</span><span class="n">var_names</span> <span class="o">=</span> <span class="n">gene_hv</span>
<span class="n">adata_spot_all</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">adata_spot_all</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">C2</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">C2</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="n">adata_spot_all</span><span class="p">)</span>
<span class="c1"># print(adata_spot_all.obs[&quot;x&quot;])</span>
<span class="c1"># print(adata_spot_all.var_names)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(80624, 596)
AnnData object with n_obs × n_vars = 80624 × 596
    obs: &#39;x&#39;, &#39;y&#39;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[66]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gene</span> <span class="o">=</span> <span class="s2">&quot;CD70&quot;</span>

<span class="n">adata_spot_all</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">gene</span><span class="p">]</span><span class="o">=</span><span class="n">adata_spot_all</span><span class="o">.</span><span class="n">X</span><span class="p">[:,</span><span class="n">adata_spot_all</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="o">==</span><span class="n">gene</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">adata_spot_all</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">gene</span><span class="p">])</span>
<span class="n">fig</span><span class="o">=</span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">adata_spot_all</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">gene</span><span class="p">,</span><span class="n">color_map</span><span class="o">=</span><span class="n">cnt_color</span><span class="p">,</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">,</span> <span class="s1">&#39;box&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_dpi</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0        0.554325
1        0.534475
2        0.505098
3        0.664154
4        0.570816
           ...
80619    0.870487
80620    0.848460
80621    0.910438
80622    0.874521
80623    0.834541
Name: CD70, Length: 80624, dtype: float64
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/BRCA_Train2_98_1.png" src="_images/BRCA_Train2_98_1.png" />
</div>
</div>
</section>
<section id="5.-Imputation-using-measured-spot-expressiom">
<h2>5. Imputation using measured spot expressiom<a class="headerlink" href="#5.-Imputation-using-measured-spot-expressiom" title="Permalink to this heading"></a></h2>
<p>5.1 Neighbours of all within spot</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[67]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">prepare_adata</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">adata_spot</span><span class="p">,</span> <span class="n">C2</span><span class="p">,</span> <span class="n">gene_hv</span><span class="p">):</span>
    <span class="c1"># adata_know: adata (original) 1331 × 596</span>
    <span class="c1"># adata_spot: all subspot 21296 × 596</span>
    <span class="n">adata_know</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">adata_know</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;spatial&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">adata_know</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;spatial&#39;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">x_sudo</span><span class="p">,</span> <span class="n">y_sudo</span> <span class="o">=</span> <span class="n">adata_spot</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">adata_spot</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">x_know</span><span class="p">,</span> <span class="n">y_know</span> <span class="o">=</span> <span class="n">adata_know</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">adata_know</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;X_sudo &amp; x_know:&quot;</span><span class="p">,</span> <span class="n">x_sudo</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">x_know</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>    <span class="c1"># X_sudo &amp; x_know: (17424,) (adata.shape[0],)</span>

    <span class="n">adata_spot</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;spatial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">adata_spot</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">adata_spot</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>

    <span class="n">xlist</span> <span class="o">=</span> <span class="n">C2</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">ylist</span> <span class="o">=</span> <span class="n">C2</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">sudo</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">xlist</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">ylist</span><span class="p">})</span>

    <span class="n">sudo_adata</span> <span class="o">=</span> <span class="n">anndata</span><span class="o">.</span><span class="n">AnnData</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sudo</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">gene_hv</span><span class="p">))))</span>
    <span class="n">sudo_adata</span><span class="o">.</span><span class="n">obs</span> <span class="o">=</span> <span class="n">sudo</span>
    <span class="n">sudo_adata</span><span class="o">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">adata_know</span><span class="o">.</span><span class="n">var</span>

    <span class="k">return</span> <span class="n">adata_know</span><span class="p">,</span> <span class="n">sudo_adata</span><span class="p">,</span> <span class="n">adata_spot</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[68]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_know</span><span class="p">,</span> <span class="n">sudo_adata_all</span><span class="p">,</span> <span class="n">adata_spot_all</span> <span class="o">=</span> <span class="n">prepare_adata</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">adata_spot_all</span><span class="p">,</span> <span class="n">C2</span><span class="p">,</span> <span class="n">gene_hv</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sudo_adata_all</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
X_sudo &amp; x_know: (80624,) (1331,)
AnnData object with n_obs × n_vars = 80624 × 596
    obs: &#39;x&#39;, &#39;y&#39;
    var: &#39;gene_ids&#39;, &#39;feature_types&#39;, &#39;genome&#39;, &#39;mt&#39;, &#39;n_cells_by_counts&#39;, &#39;mean_counts&#39;, &#39;log1p_mean_counts&#39;, &#39;pct_dropout_by_counts&#39;, &#39;total_counts&#39;, &#39;log1p_total_counts&#39;, &#39;n_cells&#39;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[69]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nearest_points</span> <span class="o">=</span> <span class="n">find_nearest_point</span><span class="p">(</span><span class="n">adata_spot_all</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;spatial&#39;</span><span class="p">],</span> <span class="n">adata_know</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;spatial&#39;</span><span class="p">])</span>
<span class="n">nbs</span><span class="p">,</span> <span class="n">nbs_indices</span> <span class="o">=</span> <span class="n">find_nearest_neighbors</span><span class="p">(</span><span class="n">nearest_points</span><span class="p">,</span> <span class="n">adata_know</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;spatial&#39;</span><span class="p">])</span>
<span class="n">distances</span> <span class="o">=</span> <span class="n">calculate_euclidean_distances</span><span class="p">(</span><span class="n">adata_spot_all</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;spatial&#39;</span><span class="p">],</span> <span class="n">nbs</span><span class="p">)</span>

<span class="c1">## Iterate over each point in sudo_adata_all</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sudo_adata_all</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="n">dis_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">distances</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">distances</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">dis_tmp</span> <span class="o">**</span> <span class="n">k</span><span class="p">))</span> <span class="o">/</span> <span class="p">((</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">dis_tmp</span> <span class="o">**</span> <span class="n">k</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span>
    <span class="n">sudo_adata_all</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">adata_know</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">nbs_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">todense</span><span class="p">())</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- </span><span class="si">%s</span><span class="s2"> seconds ---&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
--- 12.08984088897705 seconds ---
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[70]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">A</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">adata_spot_all</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sudo_adata_all</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[0.         0.         0.         ... 1.4639113  0.         0.        ]
 [1.5438051  0.90541154 0.90541154 ... 0.90541154 1.5438051  0.551857  ]
 [0.         0.         1.0923328  ... 0.         0.         0.        ]
 ...
 [0.68265146 0.         0.         ... 0.68265146 1.0845934  1.0845934 ]
 [0.         0.         0.         ... 0.         1.2505107  0.        ]
 [0.6407335  0.         0.         ... 0.         1.3066062  0.        ]]
[[1.31799281 0.56362665 1.01991451 ... 1.09909415 2.46734881 1.40222216]
 [1.33040011 0.56309283 1.04158568 ... 1.099581   2.4346807  1.40167749]
 [1.32670617 0.55537564 1.05652225 ... 1.08821797 2.3501575  1.38864398]
 ...
 [1.28910756 0.64031994 0.81899369 ... 1.16513872 3.26231074 1.47897673]
 [1.30654907 0.62080795 0.8467086  ... 1.16910458 3.15758348 1.46908164]
 [1.28763533 0.59709299 0.85100269 ... 1.1526233  3.03158903 1.43560588]]
[[0.19212073 0.14295181 0.21724944 ... 0.92930197 0.16669527 0.22734294]
 [0.16373539 0.11892636 0.17475145 ... 1.02403174 0.13173428 0.18747924]
 [0.16464067 0.11652108 0.16633396 ... 1.03570959 0.12368388 0.18222492]
 ...
 [0.31495098 0.         0.04856737 ... 0.06627508 1.35564103 0.03331399]
 [0.29934889 0.         0.0452219  ... 0.06731254 1.36170086 0.03294486]
 [0.2850267  0.         0.04221622 ... 0.06874301 1.36696496 0.03267428]]
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[71]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## save two adata</span>
<span class="c1"># patientxy = &#39;Patient1&#39;</span>
<span class="c1"># adata_spot_all.write_h5ad(str(path)+&#39;FineST/FineST/Dataset/ImputData/&#39;+str(patientxy)+&#39;/&#39;+str(patientxy)+&#39;_adata_spot_all.h5ad&#39;)</span>
<span class="c1"># sudo_adata_all.write_h5ad(str(path)+&#39;FineST/FineST/Dataset/ImputData/&#39;+str(patientxy)+&#39;/&#39;+str(patientxy)+&#39;_sudo_adata_all.h5ad&#39;)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[72]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Load two data</span>
<span class="c1"># patientxy = &#39;Patient1&#39;</span>
<span class="c1"># os.chdir(str(path)+&#39;FineST/FineST/Dataset/ImputData/&#39;+str(patientxy)+&#39;/&#39;)</span>
<span class="c1"># adata_spot_all = sc.read_h5ad(filename=str(patientxy)+&#39;_adata_spot_all.h5ad&#39;)</span>
<span class="c1"># sudo_adata_all = sc.read_h5ad(filename=str(patientxy)+&#39;_sudo_adata_all.h5ad&#39;)</span>
</pre></div>
</div>
</div>
<p>5.2 Add inference and impution data</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[73]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">sudo_adata_all</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">adata_spot_all</span><span class="p">)</span>
<span class="c1"># print(sudo_adata_all.obs[&#39;x&#39;])</span>
<span class="c1"># print(adata_spot_all.obs[&#39;x&#39;])</span>

<span class="c1"># using the weight and add</span>
<span class="n">w1</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">weight_impt_data_all</span> <span class="o">=</span> <span class="n">w1</span><span class="o">*</span><span class="n">adata_spot_all</span><span class="o">.</span><span class="n">X</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">w1</span><span class="p">)</span><span class="o">*</span><span class="n">sudo_adata_all</span><span class="o">.</span><span class="n">X</span>
<span class="n">adata_impt_all</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">AnnData</span><span class="p">(</span><span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">weight_impt_data_all</span><span class="p">))</span>

<span class="n">adata_impt_all</span><span class="o">.</span><span class="n">var_names</span> <span class="o">=</span> <span class="n">gene_hv</span>
<span class="n">adata_impt_all</span><span class="o">.</span><span class="n">obs</span> <span class="o">=</span> <span class="n">adata_spot_all</span><span class="o">.</span><span class="n">obs</span>
<span class="c1"># print(&quot;adata_impt_all: &quot;, adata_impt_all)</span>
<span class="c1"># print(adata_impt_all.obs[&#39;x&#39;])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
AnnData object with n_obs × n_vars = 80624 × 596
    obs: &#39;x&#39;, &#39;y&#39;
    var: &#39;gene_ids&#39;, &#39;feature_types&#39;, &#39;genome&#39;, &#39;mt&#39;, &#39;n_cells_by_counts&#39;, &#39;mean_counts&#39;, &#39;log1p_mean_counts&#39;, &#39;pct_dropout_by_counts&#39;, &#39;total_counts&#39;, &#39;log1p_total_counts&#39;, &#39;n_cells&#39;
AnnData object with n_obs × n_vars = 80624 × 596
    obs: &#39;x&#39;, &#39;y&#39;, &#39;CD70&#39;
    obsm: &#39;spatial&#39;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[74]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">weight_impt_data_all_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">weight_impt_data_all</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">weight_impt_data_all_tensor</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">weight_impt_data_all_tensor</span><span class="p">[:</span><span class="mi">10</span><span class="p">])</span>

<span class="n">_</span><span class="p">,</span> <span class="n">adata_impt_all_reshape</span> <span class="o">=</span> <span class="n">reshape_latent_image</span><span class="p">(</span><span class="n">weight_impt_data_all_tensor</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">adata_impt_all_reshape</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">adata_impt_all_reshape</span><span class="p">[:</span><span class="mi">10</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
torch.Size([80624, 596])
tensor([[0.7551, 0.3533, 0.6186,  ..., 1.0142, 1.3170, 0.8148],
        [0.7471, 0.3410, 0.6082,  ..., 1.0618, 1.2832, 0.7946],
        [0.7457, 0.3359, 0.6114,  ..., 1.0620, 1.2369, 0.7854],
        ...,
        [0.7225, 0.3455, 0.5528,  ..., 1.0732, 1.3578, 0.7880],
        [0.6908, 0.3626, 0.4906,  ..., 1.0599, 1.5304, 0.7918],
        [0.6603, 0.3263, 0.4673,  ..., 1.1522, 1.4382, 0.7454]],
       dtype=torch.float64)
torch.Size([5039, 596])
tensor([[0.7114, 0.3459, 0.5409,  ..., 1.0766, 1.3782, 0.7821],
        [1.1502, 0.6222, 0.7276,  ..., 0.9088, 1.9652, 0.9071],
        [0.6043, 0.3282, 0.7858,  ..., 0.5805, 1.4134, 0.6444],
        ...,
        [0.7713, 0.4575, 0.5606,  ..., 0.9314, 2.1450, 1.0506],
        [0.9161, 0.4793, 0.4842,  ..., 0.8907, 1.7709, 0.9171],
        [0.7137, 0.3250, 0.8277,  ..., 0.8162, 1.6566, 0.7935]],
       dtype=torch.float64)
</pre></div></div>
</div>
<p>5.3 save the imputation spot data</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[75]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_impt_spot</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">AnnData</span><span class="p">(</span><span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">adata_impt_all_reshape</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()))</span>
<span class="n">adata_impt_spot</span><span class="o">.</span><span class="n">var_names</span> <span class="o">=</span> <span class="n">gene_hv</span>
<span class="n">adata_impt_spot</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spatial_loc_all</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
<span class="n">adata_impt_spot</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spatial_loc_all</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;adata_impt_spot: &quot;</span><span class="p">,</span> <span class="n">adata_impt_spot</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">adata_impt_spot</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
adata_impt_spot:  AnnData object with n_obs × n_vars = 5039 × 596
    obs: &#39;x&#39;, &#39;y&#39;
0       10014.0
1       10015.0
2       10016.0
3       10020.0
4       10021.0
         ...
5034     9978.0
5035     9978.5
5036     9979.0
5037     9980.0
5038     9980.5
Name: x, Length: 5039, dtype: float64
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[76]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## save data: 5039 × 596</span>
<span class="c1"># patientxy = &#39;patient1&#39;</span>
<span class="c1"># os.chdir(str(path)+&#39;FineST/FineST/Dataset/ImputData/&#39;+str(patientxy)+&#39;/&#39;)</span>
<span class="c1"># adata_impt_spot.write_h5ad(filename=str(patientxy)+&#39;_adata_all_spot.h5ad&#39;)</span>
</pre></div>
</div>
</div>
<p>5.4 Visualization: gene at all spot</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[77]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_gene_data_single</span><span class="p">(</span><span class="n">spatial_loc</span><span class="p">,</span> <span class="n">genedata</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
    <span class="n">normalized_data</span> <span class="o">=</span> <span class="n">genedata</span>
    <span class="c1"># normalized_data = (genedata - genedata.min()) / (genedata.max() - genedata.min())</span>
    <span class="n">scatter</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">spatial_loc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">spatial_loc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">normalized_data</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cnt_color</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">scatter</span>

<span class="c1">#################################################################################################################</span>
<span class="n">gene</span> <span class="o">=</span> <span class="s2">&quot;CD70&quot;</span>

<span class="c1">## Imputed all subspot data</span>
<span class="n">imputed_matrix_test_exp_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">adata_impt_all_reshape</span><span class="p">)</span>
<span class="n">imputed_matrix_test_exp_all</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">gene_hv</span>
<span class="n">genedata2</span> <span class="o">=</span> <span class="n">imputed_matrix_test_exp_all</span><span class="p">[[</span><span class="n">gene</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;genedata2:&quot;</span><span class="p">,</span> <span class="n">genedata2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="n">scatter2</span> <span class="o">=</span> <span class="n">plot_gene_data_single</span><span class="p">(</span><span class="n">spatial_loc_all</span><span class="p">,</span> <span class="n">genedata2</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">gene</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; Expression: all subspot Imputation&quot;</span><span class="p">,</span>  <span class="n">ax</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scatter2</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_dpi</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="c1"># plt.savefig(str(gene)+&quot;_Expression_Imputation_allsubspot.pdf&quot;, format=&quot;pdf&quot;)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
genedata2: (5039, 1)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/BRCA_Train2_114_1.png" src="_images/BRCA_Train2_114_1.png" />
</div>
</div>
<p>5.5 Visualization: gene at all sub-spot</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[89]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gene</span> <span class="o">=</span> <span class="s2">&quot;CD70&quot;</span>

<span class="n">adata_spot_all</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">gene</span><span class="p">]</span><span class="o">=</span><span class="n">adata_impt_all</span><span class="o">.</span><span class="n">X</span><span class="p">[:,</span><span class="n">adata_impt_all</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="o">==</span><span class="n">gene</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">adata_spot_all</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">gene</span><span class="p">])</span>
<span class="n">fig</span><span class="o">=</span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">adata_impt_all</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">gene</span><span class="p">,</span><span class="n">color_map</span><span class="o">=</span><span class="n">cnt_color</span><span class="p">,</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">,</span> <span class="s1">&#39;box&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_dpi</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0        0.277162
1        0.267238
2        0.252549
3        0.332077
4        0.285408
           ...
80619    0.581720
80620    0.564013
80621    0.603303
80622    0.593764
80623    0.581188
Name: CD70, Length: 80624, dtype: float64
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/BRCA_Train2_116_1.png" src="_images/BRCA_Train2_116_1.png" />
</div>
</div>
</section>
<section id="6.-Save-all-subspot-imupted-data">
<h2>6. Save all subspot imupted data<a class="headerlink" href="#6.-Save-all-subspot-imupted-data" title="Permalink to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[78]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">adata_impt_all</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
AnnData object with n_obs × n_vars = 80624 × 596
    obs: &#39;x&#39;, &#39;y&#39;, &#39;CD70&#39;
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[87]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## save adata: 80624 × 596</span>
<span class="c1"># patientxy = &#39;patient1&#39;</span>
<span class="c1"># os.chdir(str(path)+&#39;FineST/FineST/Dataset/ImputData/&#39;+str(patientxy)+&#39;/&#39;)</span>
<span class="c1"># adata_impt_all.write_h5ad(filename=str(patientxy)+&#39;_adata_all.h5ad&#39;)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[88]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## End</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="release.html" class="btn btn-neutral float-left" title="Release History" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Lingyu Li.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>